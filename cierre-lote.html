<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cierre de lote • Óptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px}
  .wrap{max-width:1100px;margin:auto}
  .card{border:1px solid #ddd;border-radius:14px;padding:14px;margin-bottom:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row>div{flex:1 1 240px}
  label{display:block;font-size:.9rem;margin-bottom:4px;color:#333}
  input,select,button{width:100%;padding:9px;border:1px solid #bbb;border-radius:10px}
  button{cursor:pointer}
  small.muted{color:#666}
  .hide{display:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.13/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.13/vfs_fonts.js"></script>
</head>
<body>
<div class="wrap">
  <h1 style="margin:0">Cierre de lote</h1>
  <p class="muted">PDF en <b>1 A4</b> + registro de ventas con egreso automático (MP/TRANSF/LINK).</p>

  <!-- === Login / Autorización === -->
  <div class="card" id="authBox">
    <div class="row">
      <div>
        <label>Email autorizado</label>
        <input id="authEmail" type="email" placeholder="tu@email..." />
        <small class="muted">Solo emails habilitados.</small>
      </div>
      <div>
        <label>PIN</label>
        <input id="authKey" type="password" placeholder="PIN" />
      </div>
      <div style="flex:0 0 180px">
        <label>&nbsp;</label>
        <button id="btnLogin">Ingresar</button>
      </div>
    </div>
    <small class="muted">Tip: queda guardado localmente (solo en esta compu/Chrome).</small>
  </div>

  <!-- === Panel principal (se muestra tras login) === -->
  <div id="app" class="hide">
    <!-- Movimiento rápido (para vos/Jime) -->
    <div class="card">
      <h3 style="margin-top:0">Movimiento rápido (venta)</h3>
      <div class="row">
        <div>
          <label>Usuario</label>
          <select id="user">
            <option value="">Seleccionar</option>
            <option>JUAN</option>
            <option>JIMENA</option>
            <option>OTRO</option>
          </select>
          <small class="muted">Si elegís JUAN/JIMENA, la descripción queda “RETIRO DE EFECTIVO” (editable).</small>
        </div>
        <div>
          <label>Forma de pago</label>
          <select id="fdp" required>
            <option value="">— Elegir —</option>
            <option>EFECTIVO</option>
            <option>MERCADOPAGO</option>
            <option>TRANSFERENCIA</option>
            <option>TARJETA DE CRÉDITO</option>
            <option>TARJETA DE DÉBITO</option>
            <option>LINK DE PAGO</option>
          </select>
        </div>
        <div>
          <label>Monto</label>
          <input id="monto" type="number" inputmode="decimal" placeholder="0" />
        </div>
        <div>
          <label>Descripción</label>
          <input id="desc" type="text" placeholder="Descripción…" />
        </div>
        <div style="flex:0 0 180px">
          <label>&nbsp;</label>
          <button id="btnRegistrar">Registrar venta</button>
        </div>
      </div>
      <small id="msg" class="muted"></small>
    </div>

    <!-- Cierre de lote -->
    <div class="card">
      <h3 style="margin-top:0">PDF Cierre (1 hoja)</h3>
      <div class="row">
        <div>
          <label>Efectivo contado en caja</label>
          <input id="efectivoContado" type="number" inputmode="decimal" placeholder="0" />
        </div>
        <div style="flex:0 0 220px">
          <label>&nbsp;</label>
          <button id="btnPDF">Generar PDF</button>
        </div>
      </div>
      <small class="muted">Llama a <code>window.renderCierreLote(ventas)</code> si querés pasar tus ventas reales.</small>
    </div>
  </div>
</div>

<!-- Canvas oculto para el gráfico -->
<canvas id="pie" width="420" height="280" style="display:none"></canvas>

<script>
/* ==================== CONFIG FRONT ==================== */
// URL de tu Apps Script (deploy /exec)
const API_URL = 'https://script.google.com/macros/s/AKfycby4Jio5ZtQKRLSxhOxc0VdsUOFUh62vuRc1S7cWTDFVuN6Mk7HpYc7AczYzyRql9ZHFAg/exec';

// Emails permitidos (para validación rápida en frontend, adicional al server)
const ALLOWED_EMAILS_FRONT = new Set([
  'a32028974@gmail.com',
  'jimenaasolis@gmail.com',
  'opticacristalgerencia@gmail.com',
  'opticacristal1125@gmail.com'
]);

/* ============ LOGIN SIMPLE (email + PIN) ============== */
const authEmail = document.getElementById('authEmail');
const authKey   = document.getElementById('authKey');
const btnLogin  = document.getElementById('btnLogin');
const app       = document.getElementById('app');
const authBox   = document.getElementById('authBox');

function restoreAuth(){
  const e = localStorage.getItem('OC_AUTH_EMAIL') || '';
  const k = localStorage.getItem('OC_AUTH_KEY') || '';
  if (e && k && ALLOWED_EMAILS_FRONT.has(e.toLowerCase())){
    authEmail.value = e; authKey.value = k;
    app.classList.remove('hide'); authBox.classList.add('hide');
  }
}
btnLogin.addEventListener('click', ()=>{
  const e = (authEmail.value||'').toLowerCase().trim();
  const k = (authKey.value||'').trim();
  if (!ALLOWED_EMAILS_FRONT.has(e) || !k){
    alert('Email no permitido o PIN vacío.');
    return;
  }
  localStorage.setItem('OC_AUTH_EMAIL', e);
  localStorage.setItem('OC_AUTH_KEY', k);
  app.classList.remove('hide'); authBox.classList.add('hide');
});
restoreAuth();

/* ====== Default descripción para JUAN/JIMENA ====== */
document.getElementById('user').addEventListener('change', e=>{
  const u = (e.target.value||'').toUpperCase();
  const desc = document.getElementById('desc');
  if ((u==='JUAN' || u==='JIMENA') && !desc.value.trim()){
    desc.value = 'RETIRO DE EFECTIVO';
    desc.select();
  }
});

/* ================== REGISTRAR VENTA =================== */
function getAuth(){ 
  return {
    authEmail: localStorage.getItem('OC_AUTH_EMAIL') || '',
    authKey:   localStorage.getItem('OC_AUTH_KEY')   || ''
  };
}
const msg = document.getElementById('msg');
document.getElementById('btnRegistrar').addEventListener('click', async ()=>{
  msg.textContent = '';
  const {authEmail, authKey} = getAuth();

  const venta = {
    fecha: new Date().toISOString(),
    empleado: document.getElementById('user').value || '',
    fdp: document.getElementById('fdp').value,
    monto: Number(document.getElementById('monto').value||0),
    descripcion: document.getElementById('desc').value || ''
    // ref opcional: podés pasar número de trabajo, etc.
  };

  if (!venta.fdp || !venta.monto){
    alert('Falta FDP y/o monto.');
    return;
  }

  try{
    const r = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'registrar_venta', venta, authEmail, authKey })
    }).then(r=>r.json());

    if (!r.ok){
      if (r.error === 'NO_AUTH') throw new Error('No autorizado (email o PIN incorrectos).');
      throw new Error(r.error || 'Error al registrar.');
    }
    msg.textContent = `OK. FDP=${r.fdp} • egresoAuto=${r.egresoAuto ? 'sí' : 'no'} • ref=${r.ref}`;
    // Limpieza rápida (dejamos descripción por si agregan varias)
    document.getElementById('monto').value = '';
  }catch(err){
    alert(err.message);
  }
});

/* ==================== CIERRE DE LOTE =================== */
// Normalización FDP para gráfico
const FDP_CANON = ["EFECTIVO","MERCADOPAGO","TRANSFERENCIA","TARJETA DE CRÉDITO","TARJETA DE DÉBITO","LINK DE PAGO"];
function normFDP(s){
  s = (s||'').toUpperCase().replace(/\s+/g,' ').replace('DEBITO','DÉBITO').replace('CREDITO','CRÉDITO').replace('MERCADO PAGO','MERCADOPAGO').replace('MP','MERCADOPAGO');
  return s;
}
function rubroFromDesc(d=''){
  const s = d.toUpperCase();
  if (s.startsWith('SOL:') || s.includes(' SOL ')) return 'SOL';
  if (s.startsWith('RECETA') || s.includes('VISIÓN') || s.includes('LEJOS') || s.includes('CERCA')) return 'RECETA';
  if (s.includes('REPARACION') || s.includes('REPARACIONES') || s.includes('VARIOS')) return 'REPARACIONES';
  if (s.includes('LENTES DE CONTACTO') || s.includes('LC ')) return 'CONTACTO';
  return 'OTROS';
}

async function pieDataURL(porMedio){
  const labels = Object.keys(porMedio), values = labels.map(k=>porMedio[k]);
  const ctx = document.getElementById('pie').getContext('2d');
  if (window.__pie__) window.__pie__.destroy();
  window.__pie__ = new Chart(ctx,{type:'pie',data:{labels,datasets:[{data:values}]},options:{plugins:{legend:{position:'bottom'}}}});
  return new Promise(res=>setTimeout(()=>res(document.getElementById('pie').toDataURL('image/png')),60));
}
function fmtMoney(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0)); }
function fechaSafe(d){const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`;}
function tablaKeyVal(rows){return{table:{widths:['*','*'],body:rows.map(([k,v])=>([{text:k,fontSize:8,color:'#333'},{text:v,fontSize:8,alignment:'right'}]))},layout:'noBorders'};}

async function generarPDF(ventas, efectivoContado){
  // Normalizar
  const v = ventas.map(x=>({
    FECHA: x.FECHA ?? x.fecha ?? '',
    EMPLEADO: (x.EMPLEADO ?? x.empleado ?? '').toString().toUpperCase(),
    FDP: normFDP(x.FDP ?? x.fdp ?? ''),
    MONTO: Number(x.MONTO ?? x.monto ?? 0) || 0,
    DESCRIPCION: (x.DESCRIPCION ?? x.descripcion ?? '').toString()
  }));
  const total = v.reduce((a,b)=>a+b.MONTO,0);

  const porMedio = {}; FDP_CANON.forEach(k=>porMedio[k]=0);
  v.forEach(r=> porMedio[r.FDP] = (porMedio[r.FDP]||0) + r.MONTO );

  const porRubro = {};
  v.forEach(r=>{ const rr = rubroFromDesc(r.DESCRIPCION); porRubro[rr]=(porRubro[rr]||0)+r.MONTO; });

  const pie = await pieDataURL(porMedio);
  const efectivoTeorico = porMedio['EFECTIVO']||0;
  const dif = Number(efectivoContado||0) - efectivoTeorico;

  const top = v.slice(0,50);
  const detalle = [
    [{text:'#',bold:true,fontSize:7},{text:'Descripción',bold:true,fontSize:7},{text:'FDP',bold:true,fontSize:7},{text:'$',bold:true,alignment:'right',fontSize:7}],
    ...top.map((r,i)=>[
      {text:String(i+1),fontSize:7},
      {text:r.DESCRIPCION,fontSize:7},
      {text:r.FDP,fontSize:7},
      {text:fmtMoney(r.MONTO),alignment:'right',fontSize:7}
    ])
  ];
  const rubrosList = Object.entries(porRubro).sort((a,b)=>b[1]-a[1]).map(([k,val])=>({text:`• ${k}: ${fmtMoney(val)}`,fontSize:8}));
  const mid = Math.ceil(rubrosList.length/2);
  const doc = {
    pageSize:'A4', pageMargins:[18,18,18,18], defaultStyle:{fontSize:9},
    content:[
      {text:'CIERRE DE LOTE • Óptica Cristal', style:'h1'},
      {text:`Fecha: ${new Date().toLocaleString('es-AR')}`, margin:[0,-4,0,6], color:'#555'},
      {columns:[
        {width:'45%', stack:[
          {text:'TOTAL VENDIDO',style:'h2',margin:[0,0,0,2]},
          {text:fmtMoney(total),style:'total'},
          {text:' ',margin:[0,6,0,0]},
          {text:'CUADRE (Efectivo)',style:'h2',margin:[0,4,0,2]},
          tablaKeyVal([['Contado en caja',fmtMoney(efectivoContado||0)],['Efectivo teórico',fmtMoney(efectivoTeorico)],['Diferencia',fmtMoney(dif)]])
        ]},
        {width:'55%', image:pie, fit:[300,220], margin:[4,0,0,0]}
      ], columnGap:8},
      {text:'Totales por rubro',style:'h2',margin:[0,6,0,2]},
      {columns:[{width:'*',stack:rubrosList.slice(0,mid)},{width:'*',stack:rubrosList.slice(mid)}],columnGap:16},
      {text:'Detalle de ventas (hasta 50)',style:'h2',margin:[0,8,0,2]},
      {table:{headerRows:1,widths:['5%','*','24%','18%'],body:detalle},layout:{paddingTop:(i)=>i===0?2:0,paddingBottom:(i)=>i===0?2:0}}
    ],
    styles:{h1:{fontSize:12,bold:true},h2:{fontSize:9,bold:true},total:{fontSize:18,bold:true}}
  };
  pdfMake.createPdf(doc).download(`cierre_lote_${fechaSafe(new Date())}.pdf`);
}

// DEMO de ventas (reemplazá por tus datos reales si querés)
const ventasDemo = [
  { FECHA:'6/11/2025', EMPLEADO:'LUCAS', FDP:'EFECTIVO', MONTO:53000, DESCRIPCION:'Receta: GETTE 1479' },
  { FECHA:'6/11/2025', EMPLEADO:'CARLA', FDP:'EFECTIVO', MONTO:96000, DESCRIPCION:'Lentes de contacto: OASYS -2.50 CAJA' },
  { FECHA:'6/11/2025', EMPLEADO:'RODRI', FDP:'TARJETA DE CRÉDITO', MONTO:208000, DESCRIPCION:'Receta: VAZQUEZ BRENDA 3325' },
  { FECHA:'6/11/2025', EMPLEADO:'RODRI', FDP:'TARJETA DE DEBITO', MONTO:33000, DESCRIPCION:'Sol: DIFERENCIA POR CAMBIO 13126' }
];

document.getElementById('btnPDF').addEventListener('click', ()=>{
  const contado = Number(document.getElementById('efectivoContado').value||0);
  generarPDF(ventasDemo, contado);
});

// API pública para que uses tu lista real: window.renderCierreLote(ventas, {efectivoContado})
window.renderCierreLote = (ventas, opts={}) => generarPDF(ventas, Number(opts.efectivoContado||0));
</script>
</body>
</html>
