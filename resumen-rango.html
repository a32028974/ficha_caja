<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>v 1 Resumen Mensual â€¢ Ã“ptica Cristal</title> 
<link rel="icon" href="logo.png" />
<style>
Â  :root{
Â  Â  --bg:#f5f6f8;
Â  Â  --panel:#fff;
Â  Â  --line:#e5e7eb;
Â  Â  --muted:#6b7280;
Â  Â  --blue:#2563eb;
Â  Â  --green:#16a34a;
Â  Â  --pill:#f9fafb;
Â  }
Â  *{ box-sizing:border-box; font-family:system-ui,Segoe UI,Arial,sans-serif; }
Â  body{ margin:0; background:var(--bg); color:#111; }
Â  header{
Â  Â  display:flex; align-items:center; gap:14px;
Â  Â  padding:10px 14px; background:#fff;
Â  Â  border-bottom:1px solid var(--line);
Â  Â  position:sticky; top:0; z-index:5;
Â  }
Â  header img{ height:42px; }
Â  .title{ font-weight:700; font-size:20px; margin-right:auto; }
Â  .badge{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:999px; font-size:13px; }
Â  .wrap{ max-width:1100px; margin:18px auto; padding:0 14px 40px; }
Â  .card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; margin:12px 0; }
Â  h3{ margin:6px 0 10px; font-size:16px; }
Â  label{ display:block; font-size:12px; color:var(--muted); margin:6px 0 4px; }
Â  input, select{
Â  Â  width:100%; padding:9px 10px;
Â  Â  border:1px solid #d1d5db; border-radius:10px;
Â  Â  font-size:14px;
Â  }
Â  .rowFilter{
Â  Â  display:grid;
Â  Â  grid-template-columns:150px 150px 1fr;
Â  Â  gap:10px;
Â  Â  align-items:end;
Â  }
Â  @media(max-width:700px){
Â  Â  .rowFilter{ grid-template-columns:1fr; }
Â  }
Â  .btn{
Â  Â  padding:9px 13px; border-radius:10px;
Â  Â  border:1px solid #d1d5db;
Â  Â  background:#fff; cursor:pointer;
Â  Â  font-size:14px;
Â  }
Â  .btn.blue{ background:var(--blue); color:#fff; border-color:var(--blue); }
Â  .pill{
Â  Â  background:var(--pill);
Â  Â  border:1px solid var(--line);
Â  Â  padding:6px 10px;
Â  Â  border-radius:999px;
Â  Â  font-size:13px;
Â  Â  display:inline-flex;
Â  Â  justify-content:space-between;
Â  Â  gap:10px;
Â  Â  width:100%;
Â  }
Â  .muted{ color:var(--muted); font-size:13px; }
Â  .grid2{
Â  Â  display:grid; grid-template-columns:1fr 1fr; gap:10px;
Â  }
Â  @media(max-width:800px){ .grid2{ grid-template-columns:1fr; } }

Â  .list{ margin-top:6px; display:flex; flex-direction:column; gap:6px; }
Â  .pill key{ font-weight:500; }
Â  .pill span{ white-space:nowrap; }

Â  .hidden{ display:none !important; }

Â  .modal{
Â  Â  position:fixed; inset:0;
Â  Â  background:rgba(0,0,0,.5);
Â  Â  display:flex; align-items:center; justify-content:center;
Â  Â  z-index:50;
Â  }
Â  .modal .inner{
Â  Â  width:100%; max-width:420px;
Â  Â  background:#fff; border-radius:14px;
Â  Â  padding:18px; border:1px solid var(--line);
Â  Â  text-align:center;
Â  }
Â  .spinner{
Â  Â  width:18px; height:18px;
Â  Â  border:3px solid #e5e7eb; border-top-color:#2563eb;
Â  Â  border-radius:50%;
Â  Â  animation:sp .9s linear infinite;
Â  Â  display:inline-block; margin-right:8px; vertical-align:middle;
Â  }
Â  @keyframes sp{ to{ transform:rotate(360deg); } }

  /* Estilos para IMPRESIÃ“N */
Â  @media print {
    body{ background: #fff; }
    .wrap{ padding-top: 0; }
    header, .card:first-child, .btn-print, #loginModal, #loadModal {
        display: none !important;
    }
    .card{ 
        border: none; 
        box-shadow: none; 
        padding: 0; 
        margin: 0;
    }
    .pill {
        border: 1px solid #ccc;
    }
    h3 {
        margin-top: 20px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
    }
Â  }
</style>
</head>
<body>
<header>
Â  <img src="logo.png" alt="Ã“ptica Cristal">
Â  <div class="title">Resumen Mensual</div> Â  <div class="badge">ğŸ“… <span id="hoy"></span></div>
Â  <div class="badge">ğŸ‘¤ <b id="empName">â€”</b></div>
Â  <button class="btn" id="btnCambiar">Cambiar empleado</button>
Â  <button class="btn btn-print" id="btnPrint" style="background:var(--green); color:#fff; border-color:var(--green); margin-left: 10px;">ğŸ–¨ï¸ Imprimir</button> </header>

<div class="wrap">

Â  Â  <section class="card">
Â  Â  <h3>Elegir periodo</h3>
Â  Â  <div class="rowFilter">
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Desde</label>
Â  Â  Â  Â  <input type="date" id="desde">
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <label>Hasta</label>
Â  Â  Â  Â  <input type="date" id="hasta">
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <button class="btn blue" id="btnResumen">Generar resumen</button>
Â  Â  Â  Â  <p class="muted" id="msgPeriodo" style="margin-top:6px"></p>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  Â  <section class="card">
Â  Â  <h3>Resumen general</h3>
Â  Â  <div id="resumenGeneral" class="muted">ElegÃ­ un rango y presionÃ¡ "Generar resumen".</div>
Â  </section>

Â  Â  <section class="card">
Â  Â  <h3>Detalle de ventas</h3>
Â  Â  <div class="grid2">
Â  Â  Â  <div>
Â  Â  Â  Â  <h4 style="margin:0 0 6px; font-size:14px;">Por forma de pago</h4>
Â  Â  Â  Â  <div id="resFdp" class="muted">â€”</div>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <h4 style="margin:0 0 6px; font-size:14px;">Por rubro</h4>
Â  Â  Â  Â  <div id="resRubro" class="muted">â€”</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

Â  <section class="card">
Â  Â  <h3>Movimientos y balance</h3>
Â  Â  <div class="grid2">
Â  Â  Â  <div>
Â  Â  Â  Â  <h4 style="margin:0 0 6px; font-size:14px;">Movimientos</h4>
Â  Â  Â  Â  <div id="resMov" class="muted">â€”</div>
Â  Â  Â  </div>
Â  Â  Â  <div>
Â  Â  Â  Â  <h4 style="margin:0 0 6px; font-size:14px;">Balance</h4>
Â  Â  Â  Â  <div id="resBalance" class="muted">â€”</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </section>

</div>

<div class="modal" id="loginModal">
Â  <div class="inner">
Â  Â  <h3>Ingresar empleado</h3>
Â  Â  <p class="muted">EscribÃ­ tu <b>cÃ³digo</b></p>
Â  Â  <label>CÃ³digo de empleado</label>
Â  Â  <input id="empCode" placeholder="">
Â  Â  <div style="display:flex; justify-content:flex-end; margin-top:12px;">
Â  Â  Â  <button class="btn" id="btnLogin">Entrar</button>
Â  Â  </div>
Â  Â  <p id="loginMsg" class="muted"></p>
Â  </div>
</div>

<div class="modal hidden" id="loadModal" aria-hidden="true">
Â  <div class="inner" style="max-width:360px;">
Â  Â  <div class="spinner"></div>
Â  Â  <b>Calculando resumenâ€¦</b>
Â  Â  <p class="muted" style="margin:8px 0 0">Consultando Caja y Ventas</p>
Â  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// === CONFIGURAR CON TU URL ACTUAL DE CAJA ===
const API_URL = 'https://script.google.com/macros/s/AKfycbypXquhlgS_gRZMnYmkNePhsjBn3WZkVfzlZNZhswGwPk3J97snc6GpDu9Vwofh6LemCg/exec';
const WITHDRAW_AUTH = ['JU','JI'];Â  // quienes pueden ver el resumen

const qs = s => document.querySelector(s);
const money = n => new Intl.NumberFormat('es-AR',{
Â  style:'currency', currency:'ARS', maximumFractionDigits:0
}).format(Number(n||0));

/* ===== Empleado ===== */
let CURRENT_EMP = null;
function setEmp(emp){
Â  CURRENT_EMP = { codigo:String(emp.codigo||'').toUpperCase(), nombre:emp.nombre||'' };
Â  qs('#empName').textContent = CURRENT_EMP.nombre || 'â€”';
}
function clearEmp(){ CURRENT_EMP=null; qs('#empName').textContent='â€”'; }
function getEmp(){ return CURRENT_EMP; }

/* ===== Modales ===== */
function showLogin(){
Â  clearEmp();
Â  qs('#loginModal').classList.remove('hidden');
Â  qs('#empCode').value='';
Â  qs('#loginMsg').textContent='';
Â  setTimeout(()=>qs('#empCode').focus(),120);
}
function hideLogin(){ qs('#loginModal').classList.add('hidden'); }

function showLoading(){ qs('#loadModal').classList.remove('hidden'); }
function hideLoading(){ qs('#loadModal').classList.add('hidden'); }

/* ===== API ===== */
async function apiGet(p){
Â  const r = await fetch(API_URL + '?' + new URLSearchParams(p).toString());
Â  return r.json();
}

/* ===== Login ===== */
async function doLogin(){
Â  const code = (qs('#empCode').value||'').trim().toUpperCase();
Â  if(!code) return;
Â  qs('#loginMsg').textContent = 'Verificando empleado...';
Â  const r = await apiGet({action:'login', code});
Â  const m = qs('#loginMsg');
Â  if(r.ok){
Â  Â  setEmp(r.data);
Â  Â  m.textContent='';
Â  Â  hideLogin();
Â  Â  // Al loguear, generar el resumen por defecto (mes anterior)
Â  Â  generarResumen(); 
Â  }else{
Â  Â  m.textContent = r.error || 'CÃ³digo invÃ¡lido';
Â  }
}

/* ===== Render helpers ===== */
function renderList(obj, elId, labelVacio){
Â  const el = qs(elId);
Â  if(!obj || Object.keys(obj).length===0){
Â  Â  el.textContent = labelVacio || 'â€”';
Â  Â  return;
Â  }
Â  el.innerHTML = '<div class="list">'
Â  Â  + Object.keys(obj).sort().map(k=>`
Â  Â  Â  <div class="pill">
Â  Â  Â  Â  <span style="font-weight:500;">${k}</span>
Â  Â  Â  Â  <span>${money(obj[k])}</span>
Â  Â  Â  </div>
Â  Â  `).join('')
Â  Â  + '</div>';
}

/* ===== Resumen rango ===== */
async function generarResumen(){
Â  const emp = getEmp();
Â  if(!emp){ showLogin(); return; }
Â  if(!WITHDRAW_AUTH.includes(emp.codigo)){
Â  Â  Swal.fire('No autorizado','','warning');
Â  Â  return;
Â  }

Â  const desde = qs('#desde').value;
Â  const hasta = qs('#hasta').value;
Â  if(!desde || !hasta){
Â  Â  Swal.fire('Fechas incompletas','ElegÃ­ fecha desde y hasta.','warning');
Â  Â  return;
Â  }
Â  if(desde > hasta){
Â  Â  Swal.fire('Rango invÃ¡lido','"Desde" no puede ser mayor a "Hasta".','warning');
Â  Â  return;
Â  }

Â  qs('#msgPeriodo').textContent = `ğŸ“† Del ${desde} al ${hasta}`;
Â  showLoading();

Â  try{
Â  Â  const r = await apiGet({
Â  Â  Â  action:'cierre_rango',
Â  Â  Â  code: emp.codigo,
Â  Â  Â  desde,
Â  Â  Â  hasta
Â  Â  });
Â  Â  hideLoading();

Â  Â  if(!r.ok){
Â  Â  Â  Swal.fire('Error', r.error || 'No se pudo calcular el resumen.','error');
Â  Â  Â  return;
Â  Â  }

Â  Â  const d = r.data || {};
Â  Â  const totalVentas = Number(d.ventasTotal || 0);
Â  Â  const dias = d.dias || 0;

Â  Â  // Resumen general
Â  Â  qs('#resumenGeneral').innerHTML = `
Â  Â  Â  <div class="pill" style="max-width:420px;">
Â  Â  Â  Â  <span>Ventas totales perÃ­odo</span>
Â  Â  Â  Â  <span>${money(totalVentas)}</span>
Â  Â  Â  </div>
Â  Â  Â  <p class="muted" style="margin-top:8px;">
Â  Â  Â  Â  DÃ­as con movimientos: <b>${dias}</b>${d.tickets ? ` Â· Comprobantes: <b>${d.tickets}</b>`:''}
Â  Â  Â  </p>
Â  Â  `;

Â  Â  renderList(d.porFdp || {}, '#resFdp', 'Sin ventas en el rango.');
Â  Â  renderList(d.porRubro || {}, '#resRubro', 'Sin datos de rubros.');

Â  Â  // Movimientos
Â  Â  const mov = d.movimientos || {};
Â  Â  const retiros = Number(mov.retiros || 0);
Â  Â  const ingresos = Number(mov.ingresos || 0);
Â  Â  const pagoProv = Number(mov.pagoProveedores || 0);
Â  Â  const otrosMov = Number(mov.otros || 0);

Â  Â  qs('#resMov').innerHTML = `
Â  Â  Â  <div class="list">
Â  Â  Â  Â  <div class="pill"><span>Retiros de caja</span><span>${money(retiros)}</span></div>
Â  Â  Â  Â  <div class="pill"><span>Ingresos a caja</span><span>${money(ingresos)}</span></div>
Â  Â  Â  Â  <div class="pill"><span>Pago a proveedores</span><span>${money(pagoProv)}</span></div>
Â  Â  Â  Â  <div class="pill"><span>Otros movimientos</span><span>${money(otrosMov)}</span></div>
Â  Â  Â  </div>
Â  Â  `;

Â  Â  // Balance
Â  Â  const balance = d.balance || {};
Â  Â  const netoCaja = Number(balance.netoCaja || 0);
Â  Â  const totalEntradas = Number(balance.totalEntradas || 0);
Â  Â  const totalSalidas = Number(balance.totalSalidas || 0);

Â  Â  qs('#resBalance').innerHTML = `
Â  Â  Â  <div class="list">
Â  Â  Â  Â  <div class="pill"><span>Entradas (ventas + ingresos)</span><span>${money(totalEntradas)}</span></div>
Â  Â  Â  Â  <div class="pill"><span>Salidas (retiros + pagos)</span><span>${money(totalSalidas)}</span></div>
Â  Â  Â  Â  <div class="pill" style="margin-top:4px;">
Â  Â  Â  Â  Â  <span style="font-weight:600;">Balance neto caja</span>
Â  Â  Â  Â  Â  <span>${money(netoCaja)}</span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `;

Â  }catch(e){
Â  Â  hideLoading();
Â  Â  Swal.fire('Error de red', e.message || 'FallÃ³ la conexiÃ³n.','error');
Â  }
}

/* ===== Funciones de Fechas y Init ===== */

function obtenerRangoMesAnterior(fechaHoy) {
    const hoy = new Date(fechaHoy);
    // Establecer el primer dÃ­a del mes actual
    const primerDiaMesActual = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    
    // Establecer el Ãºltimo dÃ­a del mes anterior (restar 1 dÃ­a al primer dÃ­a del mes actual)
    const ultimoDiaMesAnterior = new Date(primerDiaMesActual.getTime());
    ultimoDiaMesAnterior.setDate(ultimoDiaMesAnterior.getDate() - 1);

    // Establecer el primer dÃ­a del mes anterior (sustituyendo el dÃ­a por 1)
    const primerDiaMesAnterior = new Date(ultimoDiaMesAnterior.getFullYear(), ultimoDiaMesAnterior.getMonth(), 1);

    // Formatear a YYYY-MM-DD
    const isoDate = (date) => date.toISOString().slice(0, 10);

    return {
        desde: isoDate(primerDiaMesAnterior),
        hasta: isoDate(ultimoDiaMesAnterior)
    };
}


function init(){
Â  const d = new Date();
Â  qs('#hoy').textContent = d.toLocaleDateString('es-AR',{
Â  Â  weekday:'short', day:'2-digit', month:'2-digit', year:'numeric'
Â  });

Â  // USAR LA FECHA DE REFERENCIA (01/12/2025) para que el rango por defecto sea el MES ANTERIOR (Noviembre)
Â  const hoyDeReferencia = '2025-12-01'; 
Â  const rango = obtenerRangoMesAnterior(hoyDeReferencia);
Â  qs('#desde').value = rango.desde;
Â  qs('#hasta').value = rango.hasta;
Â  qs('#msgPeriodo').textContent = `ğŸ“† Del ${rango.desde} al ${rango.hasta}`;


Â  qs('#btnCambiar').onclick = showLogin;
Â  qs('#btnLogin').onclick = doLogin;
Â  qs('#empCode').addEventListener('keydown', e=>{
Â  Â  if(e.key==='Enter'){ e.preventDefault(); doLogin(); }
Â  });

Â  qs('#btnResumen').onclick = generarResumen;
Â  qs('#btnPrint').onclick = () => window.print(); // FunciÃ³n para imprimir aÃ±adida

Â  // abrir login al inicio
Â  showLogin();

Â  // Enfocar cÃ³digo siempre que se abra el modal
Â  const modal = qs('#loginModal');
Â  new MutationObserver(()=>setTimeout(()=>qs('#empCode').focus(),120))
Â  Â  .observe(modal,{attributes:true,attributeFilter:['class']});
}
init();
</script>
</body>
</html>
