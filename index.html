<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emitir Comprobante â€¢ Ã“ptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
:root{ --bg:#f5f6f8; --panel:#fff; --line:#e5e7eb; --muted:#6b7280; --blue:#2563eb; --green:#16a34a; --pill:#f9fafb; }
*{ box-sizing:border-box; font-family:system-ui,Segoe UI,Arial,sans-serif; }
body{ margin:0; background:var(--bg); color:#111; }
header{ display:flex; align-items:center; gap:14px; padding:10px 14px; background:#fff; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:5;}
header img{ height:42px; }
.title{ font-weight:700; font-size:20px; margin-right:auto; }
.badge{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:999px; font-size:13px; }
.wrap{ max-width:1100px; margin:18px auto; padding:0 14px 80px; }
.card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; margin:12px 0; }
h3{ margin:6px 0 10px; font-size:16px; }
label{ display:block; font-size:12px; color:var(--muted); margin:6px 0 4px; }
input, select{ width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:15px; }
.rowTop{ display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:end; }
.rowBottom{ display:grid; grid-template-columns:170px 150px 220px 160px; gap:10px; align-items:end; }
.btn{ padding:10px 14px; border:1px solid #d1d5db; border-radius:10px; background:#fff; cursor:pointer; }
.btn.blue{ background:var(--blue); color:#fff; border-color:var(--blue); }
.btn.green{ background:var(--green); color:#fff; border-color:var(--green); }
.pill{ background:var(--pill); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:13px; }
.muted{ color:var(--muted); }
.hidden{ display:none !important; }
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:50;}
.modal .inner{ width:100%; max-width:420px; background:#fff; border-radius:14px; padding:18px; border:1px solid var(--line);}
</style>
</head>
<body>

<header>
<img src="logo.png" alt="Ã“ptica Cristal">
<div class="title">Emitir Comprobante v7 </div>
<div class="badge">ðŸ“… <span id="hoy"></span></div>
<div class="badge">ðŸ‘¤ <b id="empName">â€”</b></div>
<button class="btn" id="btnCambiar">Cambiar empleado</button>
</header>

<div class="wrap">

<section class="card">
<h3>Datos del Comprobante</h3>
<div class="pill">Fecha: <span id="fechaHoy" style="margin-left:6px"></span></div>
</section>

<section class="card">
  <h3>Conceptos a facturar</h3>

  <!-- Fila 1: CÃ³digo + DescripciÃ³n -->
  <div class="rowTop">
    <div>
      <label>CÃ³digo</label>
      <input id="inpCodigo" placeholder="EscaneÃ¡ o escribÃ­ y Enter">
    </div>
    <div>
      <label>DescripciÃ³n</label>
      <input id="inpDesc" placeholder="Se completa desde Stock (editable)">
    </div>
  </div>

  <!-- Fila 2: Rubro + Precio + FDP 1 + Registrar -->
  <div class="rowBottom" style="margin-top:10px">
    <div>
      <label>Rubro</label>
      <select id="inpRubro" required>
        <option value="">â€” Elegir rubro â€”</option>
        <option>Receta</option>
        <option>Lentes de contacto</option>
        <option>LÃ­quidos LC</option>
        <option>Reparaciones y varios</option>
        <option>Sol</option>
        <option>Fotos y pilas</option>
      </select>
    </div>
    <div>
      <label>Precio Unit.</label>
      <input type="number" id="inpUnit" inputmode="decimal" placeholder="0">
    </div>
    <div>
      <label>Forma de pago</label>
      <select id="fdp1" required>
        <option value="">â€” Elegir forma â€”</option>
        <option>EFECTIVO</option>
        <option>MERCADOPAGO</option>
        <option>TRANSFERENCIA</option>
        <option>TARJETA DE CRÃ‰DITO</option>
        <option>TARJETA DE DEBITO</option>
        <option>LINK DE PAGO</option>
      </select>
    </div>
    <div style="display:flex; gap:6px;">
      <button class="btn blue" id="btnAgregar">Registrar venta</button>
      <button class="btn" id="btnToggleMedios">2 medios</button>
    </div>
  </div>

  <!-- MODO 2 MEDIOS -->
  <div id="medios2" class="hidden" style="margin-top:12px; border-top:1px solid #ddd; padding-top:12px;">

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <div>
        <label>Forma de pago 2</label>
        <select id="fdp2">
          <option value="">â€” Elegir forma â€”</option>
          <option>EFECTIVO</option>
          <option>MERCADOPAGO</option>
          <option>TRANSFERENCIA</option>
          <option>TARJETA DE CRÃ‰DITO</option>
          <option>TARJETA DE DEBITO</option>
          <option>LINK DE PAGO</option>
        </select>
      </div>
      <div>
        <label>Monto 2 (auto)</label>
        <input type="number" id="monto2" inputmode="decimal" placeholder="0">
      </div>
    </div>
  </div>

  <div style="margin-top:10px">
    <label>Observaciones</label>
    <input id="obs" placeholder="">
  </div>

  <div id="msgLinea" class="muted" style="margin-top:8px"></div>
</section>

<section class="card">
<h3>Ãšltimas ventas (3)</h3>
<div id="ultimas" class="muted">â€”</div>
</section>

</div>

<div class="modal" id="loginModal">
<div class="inner">
<h3>Ingresar empleado</h3>
<p class="muted">EscribÃ­ tu inicial <b>cÃ³digo</b></p>
<label>CÃ³digo de empleado</label>
<input id="empCode" placeholder="">
<div style="display:flex; justify-content:flex-end; margin-top:12px;">
<button class="btn" id="btnLogin">Entrar</button>
</div>
<p id="loginMsg" class="muted"></p>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwjm1gbV0dNTVkxiFA9zkMfG7FmmYMWU9yH_8TTr39b9EJxWAskEsH3YtGwJNZxYyTG/exec';
const WITHDRAW_AUTH = ['JU','JI'];
const qs = s => document.querySelector(s);
const money = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));

function setEmp(emp){
localStorage.setItem('OC_EMP_CODE',(emp.codigo+'').toUpperCase());
localStorage.setItem('OC_EMP_NAME',emp.nombre);
qs('#empName').textContent=emp.nombre;
}

function getEmp(){
return {codigo:(localStorage.getItem('OC_EMP_CODE')||'').toUpperCase(), nombre:localStorage.getItem('OC_EMP_NAME')||''};
}

function showLogin(){ qs('#loginModal').classList.remove('hidden'); }
function hideLogin(){ qs('#loginModal').classList.add('hidden'); }

async function apiGet(p){
const r=await fetch(API_URL+'?'+new URLSearchParams(p));
return r.json();
}

async function apiPost(payload){
const r=await fetch(API_URL,{method:'POST', body:JSON.stringify(payload)});
return r.json();
}

async function buscarStock(num){
const r = await apiGet({action:'stock_get', num});
return r.ok ? r.data : null;
}

async function lookupDesdeCodigo(e){
if(e.key!=='Enter' && e.key!=='Tab') return;
e.preventDefault();
const code = qs('#inpCodigo').value.trim();
if(!code){ qs('#inpDesc').focus(); return; }
const it = await buscarStock(code);
if(it){
qs('#inpDesc').value = it.descripcion || '';
qs('#inpUnit').value = Number(it.precio||0);
}
qs('#inpDesc').focus();
}

async function guardarVenta(){
const emp=getEmp();
if(!emp.codigo){ showLogin(); return; }
const codigo=qs('#inpCodigo').value.trim();
const rubro =qs('#inpRubro').value;
const desc =qs('#inpDesc').value.trim();
const unit =Number(qs('#inpUnit').value||0);
const fdp =qs('#fdp').value;
const obs =qs('#obs').value.trim();

if(!rubro){ Swal.fire('Falta rubro','','warning'); return; }
if(!fdp){ Swal.fire('Falta forma de pago','','warning'); return; }
if(!desc || unit<=0){ Swal.fire('Faltan datos','','warning'); return; }

const descFinal = `${rubro}: ${desc}`.trim();

Swal.fire({title:'Guardandoâ€¦',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
let payload = {
  action:'venta_add',
  empleadoCodigo: emp.codigo,
  numItem: codigo,
  precioItem: unit,
  descripcion: descFinal,
  obs
};

if (modo2Medios) {
  payload.pagos = [
    { fdp: qs('#fdp1').value, monto: Number(qs('#monto2').value) },
    { fdp: qs('#fdp2').value, monto: Number(qs('#inpUnit').value) - Number(qs('#monto2').value) }
  ];
} else {
  payload.fdp = qs('#fdp1').value;
  payload.monto = unit;
}

const res = await apiPost(payload);

Swal.close();

if(res.ok){
qs('#inpCodigo').value='';
qs('#inpDesc').value='';
qs('#inpUnit').value='';
qs('#inpRubro').value='';
qs('#fdp').value='';
qs('#obs').value='';
Swal.fire({icon:'success',title:'Venta registrada',timer:1300,showConfirmButton:false});
setTimeout(()=>showLogin(),500);
}
}

async function doLogin(){
const code=qs('#empCode').value.trim().toUpperCase();
if(!code) return;
const r=await apiGet({action:'login', code});
if(r.ok){
setEmp(r.data);
hideLogin();
qs('#inpCodigo').focus();
}else{
qs('#loginMsg').textContent='CÃ³digo invÃ¡lido';
}
}

let modo2Medios = false;

qs('#btnToggleMedios').onclick = () => {
  modo2Medios = !modo2Medios;
  qs('#medios2').classList.toggle('hidden', !modo2Medios);
  qs('#btnToggleMedios').textContent = modo2Medios ? '1 medio' : '2 medios';
  if (modo2Medios) {
    calcularSaldo();
  }
};

function calcularSaldo() {
  const total = Number(qs('#inpUnit').value || 0);
  const p1 = Number(qs('#monto2').value || 0);
  qs('#monto2').value = Math.max(total - p1, 0);
}

qs('#inpUnit').addEventListener('input', calcularSaldo);
qs('#monto2').addEventListener('input', calcularSaldo);

  
function init(){
const d=new Date();
qs('#hoy').textContent=d.toLocaleDateString('es-AR',{weekday:'short',day:'2-digit',month:'2-digit',year:'numeric'});
qs('#fechaHoy').textContent=d.toLocaleDateString('es-AR');

qs('#inpCodigo').addEventListener('keydown', lookupDesdeCodigo);
qs('#btnAgregar').onclick = guardarVenta;
qs('#btnLogin').onclick=doLogin;
qs('#btnCambiar').onclick=showLogin;
qs('#empCode').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doLogin(); }})

const emp=getEmp();
if(!emp.codigo){ showLogin(); }
else qs('#empName').textContent=emp.nombre;
}
init();

/* âœ… AUTOFOCUS SIEMPRE EN MODAL */
function focusLogin(){
setTimeout(()=>qs('#empCode').focus(), 120);
}
const modal = qs('#loginModal');
const obs = new MutationObserver(focusLogin);
obs.observe(modal, { attributes:true, attributeFilter:['class'] });

</script>
</body>
</html>
