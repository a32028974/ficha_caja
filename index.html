<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Caja diaria â€¢ Ã“ptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
  :root { --bg:#f6f7f9; --card:#fff; --muted:#667085; --ok:#0a7; --err:#c33; }
  * { box-sizing: border-box; font-family: system-ui, Arial, sans-serif; }
  body { margin:0; background:var(--bg); color:#111; }
  header { display:flex; gap:12px; align-items:center; padding:12px 16px; background:#fff; border-bottom:1px solid #e5e7eb; position:sticky; top:0; }
  header .tag { padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; background:#fafafa; font-size:14px; }
  main { max-width:980px; margin:18px auto; padding:0 12px 60px; }
  .card { background:var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:14px; margin-bottom:14px; }
  h2 { margin:4px 0 10px; font-size:18px; }
  label { display:block; font-size:13px; color:var(--muted); margin:8px 0 6px; }
  input, select, textarea { width:100%; padding:10px 12px; border:1px solid #d0d5dd; border-radius:10px; font-size:15px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
  .row3 { display:grid; grid-template-columns: 1.2fr 1fr 1fr; gap:10px; }
  .btn { padding:10px 14px; border-radius:10px; border:1px solid #d0d5dd; background:#fff; cursor:pointer; }
  .btn.primary { background:#111; color:#fff; border-color:#111; }
  .btn.ghost { background:#fff; }
  .right { display:flex; gap:8px; justify-content:flex-end; }
  table { width:100%; border-collapse: collapse; }
  th, td { padding:10px; border-bottom:1px solid #eee; font-size:14px; text-align:left; }
  .tot { display:grid; grid-template-columns:repeat(5, 1fr); gap:10px; }
  .pill { border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fafafa; }
  .ok { color:var(--ok); } .err{ color:var(--err); }
  .modal { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; }
  .hide { display:none; }
  .modal .inner { width:100%; max-width:400px; background:#fff; border-radius:16px; padding:18px; }
</style>
</head>
<body>

<header>
  <div class="tag">ðŸ“… <span id="hoy"></span></div>
  <div class="tag">ðŸ‘¤ Empleado: <b id="empName">â€”</b></div>
  <div class="right" style="margin-left:auto">
    <button class="btn" id="btnCambiar">Cambiar empleado</button>
    <button class="btn" id="btnTotales">Refrescar totales</button>
    <button class="btn primary" id="btnCierre">Cierre del dÃ­a (PDF)</button>
  </div>
</header>

<main>
  <!-- VENTA -->
  <section class="card">
    <h2>Venta</h2>
    <div class="row3">
      <div>
        <label>Forma de pago</label>
        <select id="fdp">
          <option>Efectivo</option>
          <option>MercadoPago</option>
          <option>Transferencia</option>
          <option>Tarjeta</option>
        </select>
      </div>
      <div>
        <label>Total cobrado</label>
        <input type="number" id="monto" inputmode="decimal" placeholder="0" />
      </div>
      <div>
        <label>NÂ° de anteojo (opcional)</label>
        <div style="display:flex; gap:8px">
          <input id="numItem" placeholder="ej. 12345" />
          <button class="btn" id="btnBuscar">Buscar</button>
        </div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Precio de stock (editable)</label>
        <input type="number" id="precioItem" inputmode="decimal" placeholder="0" />
      </div>
      <div>
        <label>DescripciÃ³n</label>
        <input id="descripcion" placeholder="Marca / Modelo / Colorâ€¦" />
      </div>
    </div>

    <label>Observaciones</label>
    <textarea id="obs" rows="2" placeholder="Opcional"></textarea>

    <div class="right" style="margin-top:10px">
      <button class="btn ghost" id="btnLimpiar">Limpiar</button>
      <button class="btn primary" id="btnVender">Agregar venta</button>
    </div>

    <p id="msgVenta"></p>
  </section>

  <!-- MOVIMIENTO -->
  <section class="card">
    <h2>Movimiento de caja</h2>
    <div class="row">
      <div>
        <label>Tipo</label>
        <select id="tipoMov">
          <option>Retiro de caja</option>
          <option>Ingreso a caja</option>
          <option>Pago proveedor</option>
        </select>
      </div>
      <div>
        <label>Monto</label>
        <input type="number" id="montoMov" inputmode="decimal" placeholder="0" />
      </div>
    </div>
    <label>DescripciÃ³n</label>
    <input id="descMov" placeholder="Detalleâ€¦" />
    <div class="right" style="margin-top:10px">
      <button class="btn primary" id="btnMov">Registrar movimiento</button>
    </div>
    <p id="msgMov"></p>
  </section>

  <!-- TOTALES -->
  <section class="card">
    <h2>Totales del dÃ­a</h2>
    <div class="tot">
      <div class="pill">Efectivo<br><b id="tEfe">$0</b></div>
      <div class="pill">MP<br><b id="tMp">$0</b></div>
      <div class="pill">Transf.<br><b id="tTr">$0</b></div>
      <div class="pill">Tarjeta<br><b id="tTj">$0</b></div>
      <div class="pill">TOTAL<br><b id="tTot">$0</b></div>
    </div>
  </section>
</main>

<!-- Modal login -->
<div class="modal" id="loginModal">
  <div class="inner">
    <h3>Ingresar empleado</h3>
    <p style="color:#667085;margin-top:-4px">EscribÃ­ tu <b>cÃ³digo</b> (ej. F1, F2â€¦). No hay clave.</p>
    <label>CÃ³digo de empleado</label>
    <input id="empCode" placeholder="F1" />
    <div class="right" style="margin-top:12px">
      <button class="btn primary" id="btnLogin">Entrar</button>
    </div>
    <p id="loginMsg"></p>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbz3NN9fyuvU0-qaMZM6am7sxopKLtKEQF59kKKeJWeEj7a11UBECFpKzlFRLR8c8qOQoA/exec';

const qs = (s)=>document.querySelector(s);
const money = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));

function setEmp(emp){ localStorage.setItem('OC_EMP_CODE', emp.codigo); localStorage.setItem('OC_EMP_NAME', emp.nombre); qs('#empName').textContent = emp.nombre; }
function getEmp(){ return {codigo: localStorage.getItem('OC_EMP_CODE')||'', nombre: localStorage.getItem('OC_EMP_NAME')||''}; }

function showLogin(){ qs('#loginModal').classList.remove('hide'); qs('#empCode').focus(); }
function hideLogin(){ qs('#loginModal').classList.add('hide'); }

async function apiGet(params){
  const url = API_URL + '?' + new URLSearchParams(params).toString();
  const r = await fetch(url); return r.json();
}
async function apiPost(payload){
  const r = await fetch(API_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
  return r.json();
}

async function doLogin(){
  const code = qs('#empCode').value.trim();
  if(!code) return;
  const res = await apiGet({action:'login', code});
  const p = qs('#loginMsg');
  if(res.ok){ setEmp(res.data); hideLogin(); p.textContent=''; refreshTotales(); }
  else { p.textContent = res.error; p.className='err'; }
}

async function buscarItem(){
  const num = qs('#numItem').value.trim();
  if(!num) return;
  const res = await apiGet({action:'stock_get', num});
  const p = qs('#msgVenta');
  if(res.ok){
    const it = res.data;
    qs('#precioItem').value = it.precio || 0;
    qs('#descripcion').value = it.descripcion || '';
    p.textContent = 'Item encontrado en Stock';
    p.className = 'ok';
  }else{
    p.textContent = res.error; p.className='err';
  }
}

async function agregarVenta(){
  const emp = getEmp();
  if(!emp.codigo){ showLogin(); return; }
  const payload = {
    action: 'venta_add',
    empleadoCodigo: emp.codigo,
    fdp: qs('#fdp').value,
    monto: Number(qs('#monto').value||0),
    numItem: qs('#numItem').value.trim(),
    precioItem: Number(qs('#precioItem').value||0),
    descripcion: qs('#descripcion').value.trim(),
    obs: qs('#obs').value.trim()
  };
  const res = await apiPost(payload);
  const p = qs('#msgVenta');
  if(res.ok){
    p.textContent = res.data.msg + ' â€¢ ' + money(res.data.totalLinea);
    p.className = 'ok';
    limpiarVenta();
    refreshTotales();
  } else { p.textContent = res.error; p.className='err'; }
}

async function agregarMov(){
  const emp = getEmp();
  if(!emp.codigo){ showLogin(); return; }
  const res = await apiPost({
    action:'mov_add',
    empleadoCodigo: emp.codigo,
    tipo: qs('#tipoMov').value,
    monto: Number(qs('#montoMov').value||0),
    descripcion: qs('#descMov').value.trim()
  });
  const p = qs('#msgMov');
  if(res.ok){ p.textContent = 'Movimiento registrado'; p.className='ok'; qs('#montoMov').value=''; qs('#descMov').value=''; refreshTotales(); }
  else { p.textContent = res.error; p.className='err'; }
}

function limpiarVenta(){
  qs('#monto').value = '';
  qs('#numItem').value = '';
  qs('#precioItem').value = '';
  qs('#descripcion').value = '';
  qs('#obs').value = '';
}

async function refreshTotales(){
  const r = await apiGet({action:'totales'});
  if(r.ok){
    const t = r.data;
    qs('#tEfe').textContent = money(t.EFECTIVO);
    qs('#tMp').textContent  = money(t.MP);
    qs('#tTr').textContent  = money(t.TRANSF);
    qs('#tTj').textContent  = money(t.TARJETA);
    qs('#tTot').textContent = money(t.TOTAL);
  }
}

async function generarCierre(){
  // opcionalmente podrÃ­as pasar ?fecha=YYYY-MM-DD
  const r = await apiGet({action:'cierre_pdf'});
  if(r.ok && r.data && r.data.link){
    window.open(r.data.link, '_blank');
  }else{
    alert(r.error || 'No se pudo generar el cierre');
  }
}

function init(){
  qs('#hoy').textContent = new Date().toLocaleDateString('es-AR', {weekday:'short', day:'2-digit', month:'2-digit', year:'numeric'});
  const emp = getEmp();
  if(!emp.codigo){ showLogin(); } else { qs('#empName').textContent = emp.nombre; }
  refreshTotales();

  qs('#btnLogin').onclick = doLogin;
  qs('#btnCambiar').onclick = ()=>{ showLogin(); };
  qs('#btnTotales').onclick = refreshTotales;
  qs('#btnBuscar').onclick = buscarItem;
  qs('#btnVender').onclick = agregarVenta;
  qs('#btnLimpiar').onclick = limpiarVenta;
  qs('#btnMov').onclick = agregarMov;
  qs('#btnCierre').onclick = generarCierre;

  qs('#empCode').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
}
init();
</script>
</body>
</html>
