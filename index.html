<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emitir Comprobante ‚Ä¢ √ìptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
  :root{
    --bg:#f5f6f8; --panel:#fff; --line:#e5e7eb; --muted:#6b7280; --green:#16a34a; --red:#dc2626; --blue:#2563eb; --pill:#f9fafb;
  }
  *{ box-sizing:border-box; font-family:system-ui,Segoe UI,Arial,sans-serif; }
  body{ margin:0; background:var(--bg); color:#111; }
  .wrap{ max-width:1100px; margin:18px auto; padding:0 14px 80px; }
  header{ display:flex; align-items:center; gap:14px; padding:10px 14px; background:#fff; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:5;}
  header img{ height:42px; }
  header .title{ font-weight:700; font-size:20px; margin-right:auto; }
  .tag{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:999px; font-size:13px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; margin:12px 0; }
  h3{ margin:6px 0 10px; font-size:16px; }
  label{ display:block; font-size:12px; color:var(--muted); margin:6px 0 4px; }
  input, select{ width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:15px; }
  .row{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
  .row5{ display:grid; grid-template-columns:120px 1fr 110px 130px 90px; gap:10px; }
  .btn{ padding:10px 14px; border:1px solid #d1d5db; border-radius:10px; background:#fff; cursor:pointer; }
  .btn.primary{ background:#111; color:#fff; border-color:#111; }
  .btn.green{ background:var(--green); color:#fff; border-color:var(--green);}
  .btn.red{ background:var(--red); color:#fff; border-color:var(--red);}
  .btn.blue{ background:var(--blue); color:#fff; border-color:var(--blue);}
  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:10px; border-bottom:1px solid var(--line); font-size:14px; text-align:left;}
  th{ background:#fbfbfc; }
  .right{ text-align:right; }
  .muted{ color:var(--muted); }
  .toolbar{ display:flex; gap:8px; align-items:center; justify-content:flex-end; }
  .flex{ display:flex; gap:10px; align-items:center; }
  .hidden{ display:none !important; }
  .badge{ background:var(--pill); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:13px; }
  .ok{ color:var(--green); } .err{ color:var(--red); }
  /* Modal login */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:50;}
  .modal .inner{ width:100%; max-width:420px; background:#fff; border-radius:14px; padding:18px; border:1px solid var(--line);}
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="√ìptica Cristal">
  <div class="title">Emitir Comprobante</div>
  <div class="badge">üìÖ <span id="hoy"></span></div>
  <div class="badge">üë§ <b id="empName">‚Äî</b></div>
  <button class="btn" id="btnCambiar">Cambiar empleado</button>
</header>

<div class="wrap">

  <!-- Datos del comprobante -->
  <section class="card">
    <h3>Datos del Comprobante</h3>
    <div class="flex" style="flex-wrap:wrap">
      <div class="badge">Fecha: <span id="fechaHoy" style="margin-left:6px"></span></div>
      <div class="badge">0005 FAC ELECTRONICA</div>
      <div class="badge">FACTURA <b style="margin-left:6px">B</b></div>
    </div>
  </section>

  <!-- Datos del cliente (plegado simple, se puede expandir luego) -->
  <section class="card">
    <h3>Datos del Cliente <span class="muted">(opcional)</span></h3>
    <div class="row" style="grid-template-columns: 1.2fr 1fr 1fr 1fr;">
      <div>
        <label>Nombre / Raz√≥n social</label>
        <input id="cliNombre" placeholder="Consumidor Final">
      </div>
      <div>
        <label>Documento (DNI/CUIT)</label>
        <input id="cliDoc" placeholder="">
      </div>
      <div>
        <label>Cond. IVA</label>
        <select id="cliIva">
          <option value="CF">Consumidor Final</option>
          <option value="RI">Resp. Inscripto</option>
          <option value="MT">Monotributo</option>
          <option value="EX">Exento</option>
        </select>
      </div>
      <div>
        <label>Contacto (opcional)</label>
        <input id="cliContacto" placeholder="Email o Tel.">
      </div>
    </div>
  </section>

  <!-- Conceptos a facturar -->
  <section class="card">
    <h3>Conceptos a facturar</h3>

    <!-- L√≠nea de captura tipo ‚Äúcomprobante‚Äù -->
    <div class="row5">
      <div>
        <label>C√≥digo / CB</label>
        <input id="inpCodigo" placeholder="Escane√° o escrib√≠ y Enter">
      </div>
      <div>
        <label>Descripci√≥n</label>
        <input id="inpDesc" placeholder="Se completa desde Stock (editable)">
      </div>
      <div>
        <label>Rubro</label>
        <select id="inpRubro">
          <option>Receta</option>
          <option>Lentes de contacto</option>
          <option>L√≠quidos LC</option>
          <option>Reparaciones y varios</option>
          <option>Sol</option>
          <option>Fotos y pilas</option>
        </select>
      </div>
      <div>
        <label>Precio Unit.</label>
        <input type="number" id="inpUnit" inputmode="decimal" placeholder="0">
      </div>
      <div>
        <label style="visibility:hidden">Agregar</label>
        <button class="btn blue" id="btnAgregar">Agregar</button>
      </div>
    </div>

    <div class="flex" style="margin-top:8px">
      <span class="muted">Tip: Enter en ‚ÄúC√≥digo/CB‚Äù busca en Stock. Si no existe, carg√° manual.</span>
      <span id="msgLinea" class="muted"></span>
    </div>

    <!-- Tabla de √≠tems -->
    <div style="margin-top:10px; overflow:auto">
      <table>
        <thead>
          <tr>
            <th style="width:90px">C√≥digo</th>
            <th>Descripci√≥n</th>
            <th style="width:120px">Rubro</th>
            <th style="width:80px">Cant</th>
            <th style="width:120px" class="right">Unit</th>
            <th style="width:80px" class="right">IVA</th>
            <th style="width:120px" class="right">Total</th>
            <th style="width:60px"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <th colspan="6" class="right">TOTAL</th>
            <th class="right" id="tneto">$0</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <!-- Datos adicionales / pago -->
  <section class="card">
    <h3>Pago</h3>
    <div class="flex" style="justify-content:space-between; flex-wrap:wrap">
      <div class="flex" style="gap:10px; flex-wrap:wrap">
        <div>
          <label>Forma de pago</label>
          <select id="fdp">
            <option>Efectivo</option>
            <option>MercadoPago</option>
            <option>Transferencia</option>
            <option>Tarjeta</option>
          </select>
        </div>
        <div>
          <label>Paga con $</label>
          <input type="number" id="pagaCon" inputmode="decimal" placeholder="(opcional)">
        </div>
        <div>
          <label>Vuelto $</label>
          <input id="vuelto" disabled>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn red" id="btnCancelar">Cancelar Comprobante</button>
        <button class="btn green" id="btnConfirmar">Confirmar Comprobante</button>
      </div>
    </div>
    <div id="msgComprobante" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- Retiros (solo JU/JI) -->
  <section class="card" id="panelRetiros" class="hidden">
    <h3>Retiros / Ingresos de caja (autorizado)</h3>
    <div class="row" style="grid-template-columns: 1fr 1fr 2fr 160px;">
      <div>
        <label>Tipo</label>
        <select id="tipoMov">
          <option>Retiro de caja</option>
          <option>Ingreso a caja</option>
          <option>Pago proveedor</option>
        </select>
      </div>
      <div>
        <label>Monto</label>
        <input type="number" id="montoMov" inputmode="decimal" placeholder="0">
      </div>
      <div>
        <label>Descripci√≥n</label>
        <input id="descMov" placeholder="Motivo">
      </div>
      <div>
        <label style="visibility:hidden">‚Äî</label>
        <button class="btn" id="btnMov">Registrar</button>
      </div>
    </div>
    <div id="msgMov" class="muted" style="margin-top:8px"></div>
  </section>

</div>

<!-- Modal login -->
<div class="modal" id="loginModal">
  <div class="inner">
    <h3>Ingresar empleado</h3>
    <p class="muted">Escrib√≠ tu <b>c√≥digo</b> (ej: C, R, L, JU, JI, S). No hay clave.</p>
    <label>C√≥digo de empleado</label>
    <input id="empCode" placeholder="JU">
    <div class="toolbar" style="margin-top:12px; justify-content:flex-end">
      <button class="btn primary" id="btnLogin">Entrar</button>
    </div>
    <p id="loginMsg" class="muted"></p>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbz3NN9fyuvU0-qaMZM6am7sxopKLtKEQF59kKKeJWeEj7a11UBECFpKzlFRLR8c8qOQoA/exec';
const WITHDRAW_AUTH = ['JU','JI']; // solo estos pueden ver el panel de retiros

// ===== Helpers
const qs = s => document.querySelector(s);
const money = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));
const toIvaPerc = () => 21; // visual, sin impacto en el env√≠o (el monto final es el que cobr√°s)
function setEmp(emp){ localStorage.setItem('OC_EMP_CODE', (emp.codigo+'').toUpperCase()); localStorage.setItem('OC_EMP_NAME', emp.nombre); qs('#empName').textContent = emp.nombre; toggleRetiros(); }
function getEmp(){ return {codigo:(localStorage.getItem('OC_EMP_CODE')||'').toUpperCase(), nombre:localStorage.getItem('OC_EMP_NAME')||''}; }
function showLogin(){ qs('#loginModal').classList.remove('hidden'); qs('#empCode').focus(); }
function hideLogin(){ qs('#loginModal').classList.add('hidden'); }
async function apiGet(params){ const r=await fetch(API_URL+'?'+new URLSearchParams(params).toString()); return r.json(); }
async function apiPost(payload){ const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); return r.json(); }

// ===== Estado
let items = []; // {codigo, desc, rubro, cant, unit, ivaPerc, total}
function recalc(){
  let total=0;
  items.forEach(it => { it.total = Number(it.cant||1)*Number(it.unit||0); total+=it.total; });
  qs('#tneto').textContent = money(total);
  const paga = Number(qs('#pagaCon').value||0);
  qs('#vuelto').value = paga ? money(paga - total) : '';
}
function render(){
  const tb = qs('#tbody'); tb.innerHTML='';
  items.forEach((it,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.codigo||''}</td>
      <td>${it.desc||''}</td>
      <td>${it.rubro||''}</td>
      <td><input type="number" value="${it.cant}" style="width:70px" data-idx="${idx}" class="qty"></td>
      <td class="right"><input type="number" value="${it.unit}" style="width:110px;text-align:right" data-idx="${idx}" class="unit"></td>
      <td class="right">${it.ivaPerc}%</td>
      <td class="right">${money(it.total)}</td>
      <td class="right"><button class="btn" data-idx="${idx}" onclick="delItem(${idx})">‚úï</button></td>`;
    tb.appendChild(tr);
  });
  // bind inputs
  tb.querySelectorAll('.qty').forEach(inp=>{
    inp.oninput = (e)=>{ const i=Number(e.target.dataset.idx); items[i].cant = Number(e.target.value||1); recalc(); render(); };
  });
  tb.querySelectorAll('.unit').forEach(inp=>{
    inp.oninput = (e)=>{ const i=Number(e.target.dataset.idx); items[i].unit = Number(e.target.value||0); recalc(); render(); };
  });
  recalc();
}
window.delItem = (idx)=>{ items.splice(idx,1); render(); }

// ===== Captura de l√≠nea
async function buscarStockPorCodigo(num){
  const r = await apiGet({action:'stock_get', num});
  return r.ok ? r.data : null;
}
async function onEnterCodigo(e){
  if(e.key !== 'Enter') return;
  const code = qs('#inpCodigo').value.trim();
  if(!code){ qs('#inpDesc').focus(); return; }
  const msg = qs('#msgLinea');
  const found = await buscarStockPorCodigo(code);
  if(found){
    qs('#inpDesc').value = found.descripcion || '';
    qs('#inpUnit').value = Number(found.precio||0);
    msg.textContent = 'Producto encontrado en Stock';
    msg.className = 'ok';
    qs('#inpDesc').focus();
  }else{
    msg.textContent = 'No existe en Stock, carg√° manual.';
    msg.className = 'err';
    qs('#inpDesc').focus();
  }
}
function agregarLinea(){
  const codigo = qs('#inpCodigo').value.trim();
  const desc   = qs('#inpDesc').value.trim();
  const unit   = Number(qs('#inpUnit').value||0);
  const rubro  = qs('#inpRubro').value;
  if(!desc || !unit){ qs('#msgLinea').textContent='Complet√° descripci√≥n y precio'; qs('#msgLinea').className='err'; return; }
  const it = {codigo, desc: `${rubro}: ${desc}`, rubro, cant:1, unit, ivaPerc: toIvaPerc(), total: unit};
  items.push(it);
  render();
  // limpiar l√≠nea
  qs('#inpCodigo').value=''; qs('#inpDesc').value=''; qs('#inpUnit').value=''; qs('#inpCodigo').focus();
  const msg = qs('#msgLinea'); msg.textContent = '√çtem agregado'; msg.className='ok';
}

// ===== Confirmar / Cancelar
async function confirmar(){
  const emp = getEmp();
  if(!emp.codigo){ showLogin(); return; }
  if(items.length===0){ qs('#msgComprobante').textContent='Agreg√° al menos un √≠tem.'; qs('#msgComprobante').className='err'; return; }

  const fdp = qs('#fdp').value;
  let okCount=0, fail=[];
  for(const it of items){
    const res = await apiPost({
      action: 'venta_add',
      empleadoCodigo: emp.codigo,
      fdp,
      monto: Number(it.total||0),
      numItem: it.codigo || '',
      precioItem: Number(it.unit||0),
      descripcion: it.desc
    });
    if(res.ok) okCount++; else fail.push(res.error||'Error');
  }
  if(fail.length===0){
    qs('#msgComprobante').textContent = `Comprobante registrado: ${okCount} √≠tems.`;
    qs('#msgComprobante').className='ok';
    items = []; render(); qs('#inpCodigo').focus();
  }else{
    qs('#msgComprobante').textContent = `Algunos √≠tems fallaron: ${fail.join(' | ')}`;
    qs('#msgComprobante').className='err';
  }
}
function cancelar(){
  items=[]; render();
  qs('#inpCodigo').value=''; qs('#inpDesc').value=''; qs('#inpUnit').value='';
  qs('#msgComprobante').textContent='Comprobante cancelado.'; qs('#msgComprobante').className='muted';
  qs('#inpCodigo').focus();
}

// ===== Retiros (solo JU/JI)
function toggleRetiros(){
  const emp = getEmp();
  const show = WITHDRAW_AUTH.includes((emp.codigo||'').toUpperCase());
  qs('#panelRetiros').classList.toggle('hidden', !show);
}
async function registrarMov(){
  const emp = getEmp();
  if(!emp.codigo){ showLogin(); return; }
  const res = await apiPost({
    action:'mov_add',
    empleadoCodigo: emp.codigo,
    tipo: qs('#tipoMov').value,
    monto: Number(qs('#montoMov').value||0),
    descripcion: qs('#descMov').value.trim()
  });
  const p = qs('#msgMov');
  if(res.ok){
    p.textContent = 'Movimiento registrado'; p.className='ok';
    qs('#montoMov').value=''; qs('#descMov').value='';
  } else { p.textContent = res.error; p.className='err'; }
}

// ===== Login
async function doLogin(){
  const code = (qs('#empCode').value||'').trim();
  if(!code) return;
  const r = await apiGet({action:'login', code});
  const m = qs('#loginMsg');
  if(r.ok){ setEmp(r.data); m.textContent=''; hideLogin(); qs('#inpCodigo').focus(); }
  else { m.textContent = r.error || 'C√≥digo inv√°lido'; m.className='err'; }
}

// ===== Init
function init(){
  const d = new Date();
  qs('#hoy').textContent = d.toLocaleDateString('es-AR',{weekday:'short', day:'2-digit', month:'2-digit', year:'numeric'});
  qs('#fechaHoy').textContent = d.toLocaleDateString('es-AR');
  // foco inicial y atajos
  qs('#inpCodigo').focus();
  qs('#inpCodigo').addEventListener('keydown', onEnterCodigo);
  qs('#btnAgregar').onclick = agregarLinea;
  qs('#btnConfirmar').onclick = confirmar;
  qs('#btnCancelar').onclick = cancelar;
  qs('#btnMov').onclick = registrarMov;
  qs('#btnLogin').onclick = doLogin;
  qs('#btnCambiar').onclick = showLogin;
  qs('#pagaCon').oninput = recalc;
  // login persistente
  const emp = getEmp();
  if(!emp.codigo){ showLogin(); } else { qs('#empName').textContent = emp.nombre; toggleRetiros(); }
  render();
}
init();
</script>
</body>
</html>
