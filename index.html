<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emitir Comprobante ‚Ä¢ √ìptica Cristal</title>
<style>
  :root{--bg:#f7f7f8;--fg:#111;--muted:#666;--line:#ddd;--btn:#1f2937;--btnH:#374151;}
  body{font-family:Arial, sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:18px}
  h1{margin:0 0 12px;font-size:1.2rem}
  .card{background:#fff;border:1px solid var(--line);border-radius:10px;padding:14px;margin-bottom:14px}
  label{display:block;font-weight:600;margin-top:10px}
  input,select,textarea,button{width:100%;padding:10px;margin-top:6px;box-sizing:border-box;font-size:16px}
  textarea{min-height:70px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  button{background:var(--btn);color:#fff;border:0;border-radius:8px;cursor:pointer}
  button:hover{background:var(--btnH)}
  #msg{position:sticky;top:0;margin-bottom:10px;padding:10px;border:1px solid var(--line);background:#fff;border-radius:8px;font-weight:600}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center}
  .modal>.box{background:#fff;border-radius:12px;border:1px solid var(--line);padding:16px;width:min(480px,90vw)}
  .hide{display:none}
</style>
</head>
<body>

<div id="msg">Listo</div>

<h1>Emitir Comprobante</h1>

<div class="card">
  <div class="row3">
    <div>
      <label for="codigo">C√≥digo</label>
      <input id="codigo" placeholder="Escane√° o escrib√≠" />
    </div>
    <div>
      <label for="fdp">Forma de pago</label>
      <select id="fdp">
        <option value="">‚Äî Elegir forma de pago ‚Äî</option>
        <option>EFECTIVO</option>
        <option>TARJETA DE D√âBITO</option>
        <option>TARJETA DE CR√âDITO</option>
        <option>TRANSFERENCIA</option>
        <option>PAY WAY</option>
      </select>
    </div>
    <div>
      <label for="monto">Precio unitario</label>
      <input id="monto" type="number" step="0.01" inputmode="decimal" value="0" />
    </div>
  </div>

  <label for="descripcion">Descripci√≥n</label>
  <textarea id="descripcion" placeholder="Se completa desde Stock (editable)"></textarea>

  <label for="observaciones">Observaciones</label>
  <input id="observaciones" placeholder="(opcional)" />

  <div class="row" style="margin-top:10px">
    <button id="btn-registrar">Registrar venta</button>
    <button id="btn-cierre">Cierre de lote (hoy)</button>
  </div>
</div>

<div class="card">
  <h3>Movimiento de Caja</h3>
  <div class="row3">
    <div>
      <label for="tipoMov">Tipo</label>
      <select id="tipoMov">
        <option value="">‚Äî Seleccionar ‚Äî</option>
        <option>Retiro de caja</option>
        <option>Ingreso de caja</option>
        <option>Pago prov.</option>
      </select>
    </div>
    <div>
      <label for="montoMov">Monto</label>
      <input id="montoMov" type="number" step="0.01" inputmode="decimal" />
    </div>
    <div>
      <label for="descMov">Descripci√≥n</label>
      <input id="descMov" placeholder="(opcional)" />
    </div>
  </div>
  <button id="btn-mov" style="margin-top:10px">Registrar movimiento</button>
</div>

<!-- Modal ingreso de empleado -->
<div id="modal" class="modal">
  <div class="box">
    <h3>Ingresar empleado</h3>
    <p>Escrib√≠ tu <b>c√≥digo</b> (viene de tu hoja ‚ÄúEmpleados‚Äù).</p>
    <div class="row">
      <input id="codVend" placeholder="Ej: JU / JI / RO / LU / CA" />
      <button id="btnLogin">Entrar</button>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const API = 'https://script.google.com/macros/s/AKfycbwD8HyjyM_biqlm3Mvxn0IjFyfx7JVYnkkLLPN24uMrSkfa3NUhtju2JSC4BZcTKUVCtg/exec';
const LS_VCOD = 'VENDEDOR_OC';
const LS_VNOM = 'VENDEDOR_NOMBRE_OC';

/* ====== HELPERS ====== */
const $ = s => document.querySelector(s);
function msg(t, ok=true){ const m=$('#msg'); m.textContent=t; m.style.color=ok?'#111':'#b00020'; }
function qs(obj){ return Object.entries(obj).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v??'')}`).join('&'); }

/* JSONP (evita CORS) */
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb = 'cb_' + Math.random().toString(36).slice(2);
    window[cb] = (data)=>{ resolve(data); delete window[cb]; s.remove(); };
    const s = document.createElement('script');
    s.src = url + (url.includes('?')?'&':'?') + 'callback=' + cb;
    s.onerror = ()=>{ delete window[cb]; s.remove(); reject(new Error('JSONP error')); };
    document.head.appendChild(s);
  });
}

/* ====== VENDEDOR ====== */
function vendedor(){ return (localStorage.getItem(LS_VCOD)||'').toUpperCase(); }
function setVendedor(cod, nom){ localStorage.setItem(LS_VCOD, cod||''); localStorage.setItem(LS_VNOM, nom||''); }
async function login(){
  const code = ($('#codVend').value||'').trim().toUpperCase();
  if(!code){ msg('Ingres√° tu c√≥digo', false); return; }
  const r = await jsonp(`${API}?action=validarVendedor&code=${encodeURIComponent(code)}`);
  if(r.ok){ setVendedor(r.codigo, r.nombre||''); $('#modal').classList.add('hide'); msg(`Hola ${r.nombre||r.codigo} üëã`); $('#codigo').focus(); }
  else{ msg(r.error||'C√≥digo inv√°lido', false); }
}

/* ====== STOCK / ART√çCULO ====== */
async function buscarCodigo(){
  const cod = ($('#codigo').value||'').trim();
  if(!cod){ $('#monto').value=0; return; }
  const r = await jsonp(`${API}?action=getArticulo&codigo=${encodeURIComponent(cod)}`);
  if (r.ok){
    $('#descripcion').value = r.descripcion || '';
    $('#monto').value = r.precio || 0;
    msg(`OK ‚Ä¢ ${cod} ‚Ä¢ $${r.precio||0}`);
  } else {
    msg(r.error || 'No encontrado', false);
    // dejamos campos editables
  }
}

/* ====== VENTA ====== */
async function registrarVenta(){
  const vend = vendedor();
  if(!vend){ $('#modal').classList.remove('hide'); msg('Ingres√° tu c√≥digo', false); return; }

  const codigo = ($('#codigo').value||'').trim();       // opcional
  const fdp    = $('#fdp').value.trim();
  const monto  = Number($('#monto').value||0)||0;
  const desc   = ($('#descripcion').value||'').trim();
  const obs    = ($('#observaciones').value||'').trim();

  if(!fdp){ msg('Eleg√≠ forma de pago', false); return; }
  if(!monto){ msg('Monto inv√°lido', false); return; }

  const url = `${API}?action=registrarVenta&` + qs({
    vendedor: vend, codigo, fdp, monto, descripcion: desc, observaciones: obs
  });
  const r = await jsonp(url);
  if(r.ok){
    if(r.tipo === 'venta_producto'){
      msg(`‚úî Venta ${r.codigo} ‚Ä¢ $${r.monto} ‚Ä¢ marcado vendido`);
    }else{
      msg(`‚úî Venta gen√©rica ‚Ä¢ $${r.monto}`);
    }
    // limpiar
    $('#codigo').value=''; $('#descripcion').value=''; $('#monto').value=0; $('#observaciones').value='';
    $('#codigo').focus();
  }else{
    msg(r.error||'No se pudo registrar', false);
  }
}

/* ====== MOVIMIENTO DE CAJA ====== */
async function registrarMovimiento(){
  const vend = vendedor();
  if(!vend){ $('#modal').classList.remove('hide'); msg('Ingres√° tu c√≥digo', false); return; }
  const tipo  = $('#tipoMov').value.trim();
  const monto = Number($('#montoMov').value||0)||0;
  const desc  = ($('#descMov').value||'').trim();
  if(!tipo){ msg('Eleg√≠ tipo', false); return; }
  if(!monto){ msg('Monto inv√°lido', false); return; }

  const url = `${API}?action=movCaja&` + qs({ vendedor: vend, tipo, monto, descripcion: desc });
  const r = await jsonp(url);
  if(r.ok){
    msg(`‚úî ${tipo} registrado: $${monto}`);
    $('#montoMov').value=''; $('#descMov').value=''; $('#tipoMov').value='';
  }else{
    msg(r.error||'No se pudo registrar', false);
  }
}

/* ====== CIERRE DE LOTE (hoy) ====== */
async function cierreHoy(){
  const r = await jsonp(`${API}?action=cierreLote`);
  if(!r.ok){ msg(r.error||'No se pudo calcular', false); return; }
  const tot = r.totales||{};
  const lineas = Object.keys(tot).map(k=>`${k}: $${tot[k]}`).join('\n');
  alert(`Cierre ${r.dia}\n\n${lineas}\n\nTOTAL: $${r.total_general}`);
}

/* ====== INIT ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  // login
  if(!vendedor()){ $('#modal').classList.remove('hide'); } else { $('#modal').classList.add('hide'); msg(`Hola ${localStorage.getItem(LS_VNOM)||vendedor()} üëã`); }
  // eventos
  $('#btnLogin').addEventListener('click', login);
  $('#codigo').addEventListener('change', buscarCodigo);
  $('#btn-registrar').addEventListener('click', registrarVenta);
  $('#btn-mov').addEventListener('click', registrarMovimiento);
  $('#btn-cierre').addEventListener('click', cierreHoy);
});
</script>

</body>
</html>
