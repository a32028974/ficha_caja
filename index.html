<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Emitir Comprobante ‚Ä¢ √ìptica Cristal</title>
<link rel="icon" href="logo.png"/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  :root{
    --bg:#f7fafc; --card:#ffffff; --line:#e5e7eb; --fg:#0f172a; --muted:#64748b;
    --accent:#2563eb; --accentText:#fff; --soft:#f1f5f9; --ok:#16a34a; --warn:#f59e0b;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Arial}
  .wrap{max-width:920px;margin:22px auto;padding:0 14px}
  h1{font-size:1.25rem;margin:0 0 12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 8px 26px rgba(2,6,23,.06)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-weight:600;margin-top:10px}
  input,select,button,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--fg);font-size:16px}
  input::placeholder{color:#9aa3af}
  textarea{min-height:70px;resize:vertical;background:#fff}
  button{cursor:pointer;border:0;background:var(--accent);color:var(--accentText);font-weight:700}
  button.secondary{background:#f8fafc;color:#0f172a;border:1px solid var(--line)}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--soft);border:1px solid var(--line);font-size:.85rem}
  #msg{margin:10px 0;padding:10px;border-radius:10px;background:var(--soft);border:1px dashed var(--line)}
  .muted{color:var(--muted);font-size:.9rem}
  .history{margin-top:16px}
  .item{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff}
  .item small{color:var(--muted)}
  .hidden{display:none}

  /* Modal vendedor */
  .modal-back{position:fixed;inset:0;background:rgba(15,23,42,.35);display:flex;align-items:center;justify-content:center;z-index:40}
  .modal{background:#fff;border:1px solid var(--line);border-radius:16px;padding:20px;width:min(420px,92vw);box-shadow:0 22px 60px rgba(2,6,23,.15)}
  .modal h2{margin:0 0 12px;font-size:1.1rem}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Emitir Comprobante <span class="badge">√ìptica Cristal</span></h1>

    <div id="msg">Complet√° forma de pago y monto</div>

    <div class="card">
      <div class="row">
        <div>
          <label for="codigo">C√≥digo de art√≠culo</label>
          <input id="codigo" placeholder="Escane√° o escrib√≠" autocomplete="off"/>
        </div>
        <div>
          <label for="precio">Precio total</label>
          <input id="precio" type="number" step="0.01" inputmode="decimal" value="0"/>
        </div>
      </div>

      <label for="descripcion">Descripci√≥n</label>
      <textarea id="descripcion" placeholder="Se completa desde Stock (editable)"></textarea>

      <label for="obs">Observaciones (opcional)</label>
      <input id="obs" placeholder="Notas‚Ä¶"/>

      <hr style="border:0;border-top:1px solid var(--line);margin:16px 0"/>

      <div class="row">
        <div>
          <label for="fdp">Forma de pago</label>
          <select id="fdp">
            <option value="">‚Äî Elegir ‚Äî</option>
            <option>EFECTIVO</option>
            <option>TARJETA DE D√âBITO</option>
            <option>TARJETA DE CR√âDITO</option>
            <option>TRANSFERENCIA</option>
            <option>PAY WAY</option>
          </select>
          <div class="muted" style="margin-top:6px">Se usar√° el <b>Precio total</b> como monto.</div>
        </div>
        <div style="display:flex;align-items:end">
          <button id="btn-registrar" class="secondary" style="width:100%;height:48px;border-width:2px;border-color:#c7d2fe;background:#eef2ff;color:#1e3a8a">Registrar venta</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btn-cierre" type="button" class="secondary">Cierre de lote (hoy)</button>
        <span class="muted" style="align-self:center">Tip: Enter en c√≥digo busca al instante.</span>
      </div>

      <div class="history">
        <div class="muted" style="margin:6px 0 8px">√öltimas 5 ventas</div>
        <div id="hist"></div>
      </div>
    </div>
  </div>

  <!-- MODAL vendedor -->
  <div id="modal-back" class="modal-back">
    <div class="modal">
      <h2>Ingresar empleado</h2>
      <div class="muted">Escrib√≠ tu <b>c√≥digo</b> (ej.: JU / JI / RO / LU / CA)</div>
      <input id="vend" placeholder="C√≥digo empleado" autocomplete="off" style="margin-top:10px"/>
      <div class="row" style="margin-top:12px">
        <button id="btn-vend" style="background:var(--accent);color:#fff">Entrar</button>
        <button id="btn-cancel" class="secondary" type="button">Cancelar</button>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const API = 'https://script.google.com/macros/s/AKfycbyF_tl-DwBa2i-2B7Uh-9naoqHBBbtXc9Xb2ae81ldu3MdAJcpxHHgXRNHG4MlmAffmhA/exec';
const LS_CODE = 'OC_V_CODE';
const LS_NAME = 'OC_V_NAME';

/* ===== SHORTCUTS ===== */
const $ = s => document.querySelector(s);
function msg(t, ok=true){ const m=$('#msg'); m.textContent=t; m.style.color=ok?'#0f172a':'#b91c1c'; }
function qs(o){ return Object.entries(o).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v??'')}`).join('&'); }
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    window[cb]=(data)=>{ resolve(data); delete window[cb]; s.remove(); };
    const s=document.createElement('script'); s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    s.onerror=()=>{ delete window[cb]; s.remove(); reject(new Error('JSONP error')); };
    document.head.appendChild(s);
  });
}

/* ===== MODAL FLOW ===== */
function requireVendedor(){
  $('#modal-back').style.display = 'flex';
  $('#vend').value='';
  setTimeout(()=>$('#vend').focus(), 50);
}
function setVendedor(code, name){
  localStorage.setItem(LS_CODE, code);
  localStorage.setItem(LS_NAME, name);
  $('#modal-back').style.display = 'none';
  msg(`Hola ${name||code} üëã  ‚Ä¢  Listo para operar`);
  $('#codigo').focus();
}
function forgetVendedor(){
  localStorage.removeItem(LS_CODE);
  localStorage.removeItem(LS_NAME);
}

/* On load */
document.addEventListener('DOMContentLoaded', async ()=>{
  const c = localStorage.getItem(LS_CODE);
  const n = localStorage.getItem(LS_NAME);
  if(c && n){ setVendedor(c,n); } else { requireVendedor(); }
  await cargarHistorial();
});

/* Validar vendedor */
async function validarVend(){
  const code = ($('#vend').value||'').trim().toUpperCase();
  if(!code){ msg('Ingres√° tu c√≥digo', false); return; }
  const r = await jsonp(`${API}?action=validarVendedor&code=${encodeURIComponent(code)}`);
  if(r.ok){ setVendedor(r.codigo, r.nombre||r.codigo); }
  else { Swal.fire({icon:'error', title:r.error||'C√≥digo inv√°lido'}); }
}
$('#btn-vend').addEventListener('click', validarVend);
$('#vend').addEventListener('keyup', e=>{ if(e.key==='Enter') validarVend(); });
$('#btn-cancel').addEventListener('click', ()=>{ $('#vend').value=''; $('#vend').focus(); });

/* ===== BUSCAR ART√çCULO (Enter en c√≥digo) ===== */
async function buscarArticulo(){
  const cod = ($('#codigo').value||'').trim();
  if(!cod) return;
  Swal.fire({title:'Buscando c√≥digo‚Ä¶', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});
  try{
    const r = await jsonp(`${API}?action=getArticulo&codigo=${encodeURIComponent(cod)}`);
    if(r.ok){
      $('#descripcion').value = r.descripcion || '';
      $('#precio').value = r.precio || 0;
      Swal.fire({icon:'success', title:'Art√≠culo encontrado', timer:950, showConfirmButton:false});
    }else{
      Swal.fire({icon:'warning', title:r.error||'No encontrado', timer:1400, showConfirmButton:false});
    }
  }catch(err){
    Swal.fire({icon:'error', title:'Error buscando c√≥digo', text:String(err)});
  }
}
$('#codigo').addEventListener('keyup', e=>{ if(e.key==='Enter') buscarArticulo(); });

/* ===== REGISTRAR VENTA ===== */
$('#btn-registrar').addEventListener('click', async ()=>{
  const vCode = localStorage.getItem(LS_CODE);
  const vName = localStorage.getItem(LS_NAME);
  if(!vCode || !vName){ requireVendedor(); return; }

  const codigo = ($('#codigo').value||'').trim();
  const descripcion = ($('#descripcion').value||'').trim();
  const precio = Number($('#precio').value||0)||0;
  const obs = ($('#obs').value||'').trim();
  const fdp = $('#fdp').value.trim();

  if(!fdp){ msg('Eleg√≠ forma de pago', false); return; }
  if(!precio){ msg('Ingres√° un monto v√°lido', false); return; }

  const url = `${API}?action=registrarVenta&` + qs({
    vendedor: vCode, vendedor_nombre: vName, codigo, descripcion, precio, fdp, observaciones: obs
  });

  Swal.fire({title:'Guardando‚Ä¶', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});
  try{
    const r = await jsonp(url);
    if(r.ok){
      Swal.fire({icon:'success', title:'Venta registrada', timer:1100, showConfirmButton:false});
      msg('Venta registrada ‚úî');

      // limpiar venta
      $('#codigo').value=''; $('#descripcion').value=''; $('#precio').value=0;
      $('#obs').value=''; $('#fdp').value='';

      // volver a pedir empleado (sin inicial guardada)
      forgetVendedor();
      requireVendedor();

      // refrescar historial
      await cargarHistorial();
    }else{
      Swal.fire({icon:'error', title:'No se pudo registrar', text:r.error||'Error'});
      msg(r.error||'No se pudo registrar', false);
    }
  }catch(err){
    Swal.fire({icon:'error', title:'Error de red', text:String(err)});
  }
});

/* ===== CIERRE DE LOTE ===== */
$('#btn-cierre').addEventListener('click', async ()=>{
  const r = await jsonp(`${API}?action=cierreLote`);
  if(!r.ok){ Swal.fire({icon:'error', title:'Error', text:r.error||'No se pudo calcular'}); return; }
  const tot = r.totales||{};
  const html = Object.keys(tot).map(k=>`<div style="margin:4px 0"><b>${k}</b>: $${tot[k]}</div>`).join('');
  Swal.fire({title:`Cierre ${r.dia}`, html: html+`<hr/><b>Total:</b> $${r.total_general}`});
});

/* ===== HISTORIAL (√∫ltimas 5) ===== */
async function cargarHistorial(){
  try{
    const r = await jsonp(`${API}?action=ultimasVentas`);
    if(!r.ok) return;
    const cont = $('#hist'); cont.innerHTML='';
    (r.items||[]).forEach(v=>{
      const el = document.createElement('div');
      el.className='item';
      el.innerHTML = `
        <div>
          <div><b>$${v.monto}</b> ‚Ä¢ ${v.fdp}</div>
          <small>${v.descripcion}</small>
        </div>
        <div style="text-align:right">
          <small>${v.fecha}</small><br/>
          <small>${v.empleado}</small>
        </div>`;
      cont.appendChild(el);
    });
    if((r.items||[]).length===0){ cont.innerHTML='<div class="muted">Sin ventas recientes</div>'; }
  }catch(_){ /* ignore */ }
}
</script>
</body>
</html>
