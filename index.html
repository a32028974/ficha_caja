<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emitir Comprobante ‚Ä¢ √ìptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
  :root{
    --bg:#f5f6f8; --panel:#fff; --line:#e5e7eb; --muted:#6b7280;
    --blue:#2563eb; --green:#16a34a; --pill:#f9fafb;
  }
  *{ box-sizing:border-box; font-family:system-ui,Segoe UI,Arial,sans-serif; }
  body{ margin:0; background:var(--bg); color:#111; }
  header{ display:flex; align-items:center; gap:14px; padding:10px 14px; background:#fff; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:5;}
  header img{ height:42px; }
  .title{ font-weight:700; font-size:20px; margin-right:auto; }
  .badge{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:999px; font-size:13px; }
  .wrap{ max-width:1100px; margin:18px auto; padding:0 14px 80px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; margin:12px 0; }
  h3{ margin:6px 0 10px; font-size:16px; }
  label{ display:block; font-size:12px; color:var(--muted); margin:6px 0 4px; }
  input, select{ width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:15px; }
  .rowTop{ display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:end; }
  .rowBottom{ display:grid; grid-template-columns:170px 150px 240px 160px; gap:10px; align-items:end; }
  .btn{ padding:10px 14px; border:1px solid #d1d5db; border-radius:10px; background:#fff; cursor:pointer; }
  .btn.blue{ background:var(--blue); color:#fff; border-color:var(--blue); }
  .btn.green{ background:var(--green); color:#fff; border-color:var(--green); }
  .pill{ background:var(--pill); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:13px; }
  .muted{ color:var(--muted); }
  .hidden{ display:none !important; }
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:50;}
  .modal .inner{ width:100%; max-width:420px; background:#fff; border-radius:14px; padding:18px; border:1px solid var(--line);}
  .two-pay{ background:#fafafa; border:1px dashed #d1d5db; border-radius:12px; padding:10px; margin-top:10px }
  .two-grid{ display:grid; grid-template-columns: 1fr 140px 1fr 140px; gap:10px; align-items:end }
  @media (max-width:920px){
    .rowBottom{ grid-template-columns:1fr 1fr; }
    .two-grid{ grid-template-columns:1fr 1fr; }
  }
</style>
</head>
<body>
<header>
  <img src="logo.png" alt="√ìptica Cristal">
  <div class="title">Emitir Comprobante v2</div>
  <div class="badge">üìÖ <span id="hoy"></span></div>
  <div class="badge">üë§ <b id="empName">‚Äî</b></div>
  <button class="btn" id="btnCambiar">Cambiar empleado</button>
</header>

<div class="wrap">

  <section class="card">
    <h3>Datos del Comprobante</h3>
    <div class="pill">Fecha: <span id="fechaHoy" style="margin-left:6px"></span></div>
  </section>

  <section class="card">
    <h3>Conceptos a facturar</h3>

    <!-- Fila 1: C√≥digo + Descripci√≥n -->
    <div class="rowTop">
      <div>
        <label>C√≥digo</label>
        <input id="inpCodigo" placeholder="Escane√° o escrib√≠ y Tab/Enter">
      </div>
      <div>
        <label>Descripci√≥n</label>
        <input id="inpDesc" placeholder="Se completa desde Stock (editable)">
      </div>
    </div>

    <!-- Fila 2: Rubro + Precio + FDP + Bot√≥n -->
    <div class="rowBottom" style="margin-top:10px">
      <div>
        <label>Rubro (obligatorio)</label>
        <select id="inpRubro" required>
          <option value="">‚Äî Elegir rubro ‚Äî</option>
          <option>RECETA</option>
          <option>ANT DE SOL</option>
          <option>LENTES DE CONTACTO</option>
          <option>LIQUIDOS PARA LC</option>
          <option>FOTOS Y PILAS</option>
          <option>VARIOS Y REPARACIONES</option>
        </select>
      </div>
      <div>
        <label>Precio Unit.</label>
        <input type="number" id="inpUnit" inputmode="decimal" placeholder="0">
      </div>
      <div>
        <label>Forma de pago (1 medio)</label>
        <select id="fdp" required>
          <option value="">‚Äî Elegir forma de pago ‚Äî</option>
          <option>EFECTIVO</option>
          <option>TARJETA DE D√âBITO</option>
          <option>TARJETA DE CR√âDITO</option>
          <option>TRANSFERENCIA</option>
          <option>PAY WAY</option>
          <option>LINK DE PAGO</option>
        </select>
      </div>
      <div>
        <label style="visibility:hidden">‚Äî</label>
        <button class="btn" id="btn2Medios">Usar 2 medios</button>
      </div>
    </div>

    <!-- 2 medios de pago -->
    <div id="twoPayBox" class="two-pay hidden">
      <div class="two-grid">
        <div>
          <label>Medio 1</label>
          <select id="fdp1">
            <option value="">‚Äî Elegir ‚Äî</option>
            <option>EFECTIVO</option>
            <option>TARJETA DE D√âBITO</option>
            <option>TARJETA DE CR√âDITO</option>
            <option>TRANSFERENCIA</option>
            <option>PAY WAY</option>
            <option>LINK DE PAGO</option>
          </select>
        </div>
        <div>
          <label>Monto 1</label>
          <input id="monto1" type="number" inputmode="decimal" placeholder="0">
        </div>
        <div>
          <label>Medio 2</label>
          <select id="fdp2">
            <option value="">‚Äî Elegir ‚Äî</option>
            <option>EFECTIVO</option>
            <option>TARJETA DE D√âBITO</option>
            <option>TARJETA DE CR√âDITO</option>
            <option>TRANSFERENCIA</option>
            <option>PAY WAY</option>
            <option>LINK DE PAGO</option>
          </select>
        </div>
        <div>
          <label>Monto 2 (resto)</label>
          <input id="monto2" type="number" inputmode="decimal" placeholder="0" readonly>
        </div>
      </div>
      <div class="muted" style="margin-top:6px">Tip: escrib√≠ el <b>Monto 1</b> y el <b>Monto 2</b> se completa con el resto.</div>
    </div>

    <div style="margin-top:10px">
      <label>Observaciones</label>
      <input id="obs" placeholder="">
    </div>

    <div class="pill" id="msgLinea" style="margin-top:8px">Enter NO guarda. Enter en ‚ÄúPrecio‚Äù guarda. Atajo <b>F9</b> = Registrar.</div>

    <div style="display:flex; gap:10px; margin-top:12px">
      <button class="btn blue" id="btnAgregar">Registrar venta</button>
    </div>
  </section>

  <section class="card">
    <h3>√öltimas ventas (3)</h3>
    <div id="ultimas" class="muted">‚Äî</div>
  </section>

  <!-- Herramientas autorizadas (retiros + cierre PDF) -->
  <section class="card hidden" id="panelRetiros">
    <h3>Retiros / Ingresos y Cierre (autorizado)</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr 2fr 140px; gap:10px; margin-bottom:10px;">
      <div>
        <label>Tipo</label>
        <select id="tipoMov">
          <option>Retiro de caja</option>
          <option>Ingreso a caja</option>
          <option>Pago proveedor</option>
        </select>
      </div>
      <div>
        <label>Monto</label>
        <input type="number" id="montoMov" inputmode="decimal" placeholder="0">
      </div>
      <div>
        <label>Descripci√≥n</label>
        <input id="descMov" placeholder="Motivo">
      </div>
      <div>
        <label style="visibility:hidden">‚Äî</label>
        <button class="btn" id="btnMov">Registrar</button>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap">
      <div>
        <label>Fecha del cierre</label>
        <input type="date" id="cierreDate">
      </div>
      <button class="btn green" id="btnCierre">Cierre del d√≠a (PDF)</button>
      <div id="msgMov" class="muted" style="margin-left:auto"></div>
    </div>
  </section>

</div>

<!-- Modal login -->
<div class="modal" id="loginModal">
  <div class="inner">
    <h3>Ingresar empleado</h3>
    <p class="muted">Escrib√≠ tu inicial <b>c√≥digo</b></p>
    <label>C√≥digo de empleado</label>
    <input id="empCode" placeholder="">
    <div style="display:flex; justify-content:flex-end; margin-top:12px;">
      <button class="btn" id="btnLogin">Entrar</button>
    </div>
    <p id="loginMsg" class="muted"></p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
/* ====== CONFIG ====== */
const API_URL = 'https://script.google.com/macros/s/AKfycbyD-M_fcXjZshw8o34isAQs_BEbbqUMF_ngtVHZy5ADgeKciKo00psk_ldsZBlnRChicg/exec';
const WITHDRAW_AUTH = ['JU','JI']; // Retiros: Juan y Jimena

/* ====== HELPERS ====== */
const qs = s => document.querySelector(s);
const money = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(Number(n||0));
function setEmp(emp){ localStorage.setItem('OC_EMP_CODE',(emp.codigo+'').toUpperCase()); localStorage.setItem('OC_EMP_NAME',emp.nombre); qs('#empName').textContent=emp.nombre; toggleAutorizados(); }
function getEmp(){ return {codigo:(localStorage.getItem('OC_EMP_CODE')||'').toUpperCase(), nombre:localStorage.getItem('OC_EMP_NAME')||''}; }
function showLogin(){ qs('#loginModal').classList.remove('hidden'); qs('#empCode').value=''; qs('#loginMsg').textContent=''; setTimeout(()=>qs('#empCode').focus(),0); }
function hideLogin(){ qs('#loginModal').classList.add('hidden'); }
async function apiGet(p){ const r=await fetch(API_URL+'?'+new URLSearchParams(p).toString()); return r.json(); }
async function apiPost(payload){ const r=await fetch(API_URL,{method:'POST', body:JSON.stringify(payload)}); return r.json(); }
let SAVING=false;
const showSaving=()=>Swal.fire({title:'Guardando‚Ä¶',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
const closeSaving=()=>Swal.close();

/* ====== UI: √öltimas ====== */
async function cargarUltimas(){
  const r = await apiGet({action:'ultimas', n:3});
  const el = qs('#ultimas');
  if(!r.ok || !r.data || r.data.length===0){ el.textContent='Sin ventas a√∫n.'; return; }
  el.innerHTML = r.data.map(u=>`<div class="pill" style="display:block;margin:6px 0">${u.hora} ‚Ä¢ ${u.emp} ‚Ä¢ ${u.fdp} ‚Ä¢ ${u.desc} ‚Ä¢ <b>${money(u.total)}</b></div>`).join('');
}

/* ====== Stock ====== */
async function buscarStock(num){
  return await apiGet({action:'stock_get', num});
}
async function lookupDesdeCodigo(e){
  if(e.key!=='Enter' && e.key!=='Tab') return;
  e.preventDefault();
  const code = (qs('#inpCodigo').value||'').trim();
  if(!code){ qs('#inpDesc').focus(); return; }
  Swal.fire({title:'Buscando c√≥digo‚Ä¶',timer:800,showConfirmButton:false, didOpen:()=>Swal.showLoading()});
  const r = await buscarStock(code);
  if(r && r.ok){
    const it = r.data || {};
    qs('#inpDesc').value = it.descripcion || '';
    qs('#inpUnit').value = Number(it.precio||0);
  }
  qs('#inpDesc').focus();
}

/* ====== Split pagos ====== */
let SPLIT=false;
function toggleTwo(){
  SPLIT = !SPLIT;
  qs('#twoPayBox').classList.toggle('hidden', !SPLIT);
  qs('#btn2Medios').textContent = SPLIT ? '1 medio de pago' : 'Usar 2 medios';
  if(SPLIT){
    // Prefill: fdp1 toma lo elegido en fdp, monto1 vac√≠o, monto2 = total
    qs('#fdp1').value = qs('#fdp').value || '';
    qs('#monto1').value = '';
    recomputeMonto2();
    setTimeout(()=>qs('#fdp1').focus(),0);
  }
}
function recomputeMonto2(){
  const total = Number(qs('#inpUnit').value||0);
  const m1 = Math.max(0, Number(qs('#monto1').value||0));
  const m2 = Math.max(0, total - m1);
  qs('#monto2').value = m2;
}

/* ====== Guardar venta ====== */
async function guardarVenta(){
  if(SAVING) return;
  const emp=getEmp(); if(!emp.codigo){ showLogin(); return; }

  const codigo=(qs('#inpCodigo').value||'').trim();
  const rubro =qs('#inpRubro').value;
  const desc  =(qs('#inpDesc').value||'').trim();
  const unit  =Number(qs('#inpUnit').value||0);
  const fdp   =qs('#fdp').value;
  const obs   =(qs('#obs').value||'').trim();

  if(!rubro){ Swal.fire('Falta rubro','Eleg√≠ un rubro.','warning'); qs('#inpRubro').focus(); return; }
  if(unit<=0 || !desc){ Swal.fire('Faltan datos','Complet√° descripci√≥n y precio > 0.','warning'); if(!desc) qs('#inpDesc').focus(); else qs('#inpUnit').focus(); return; }

  const descFinal = `${rubro}: ${desc}`.trim();

  try{
    SAVING=true; qs('#btnAgregar').disabled=true; showSaving();

    if(SPLIT){
      const f1 = qs('#fdp1').value;
      const f2 = qs('#fdp2').value;
      const m1 = Number(qs('#monto1').value||0);
      const m2 = Number(qs('#monto2').value||0);
      if(!f1 || !f2){ closeSaving(); qs('#btnAgregar').disabled=false; SAVING=false; return Swal.fire('Faltan medios','Eleg√≠ ambos medios de pago.','warning'); }
      if(m1+m2 !== unit){ /* tolerancia */ }
      // 1a l√≠nea
      await apiPost({ action:'venta_add', empleadoCodigo: emp.codigo, fdp:f1, monto:m1, numItem: codigo, precioItem: unit, descripcion: descFinal, obs });
      // 2a l√≠nea
      await apiPost({ action:'venta_add', empleadoCodigo: emp.codigo, fdp:f2, monto:m2, numItem: codigo, precioItem: unit, descripcion: descFinal, obs });
    }else{
      if(!fdp){ closeSaving(); qs('#btnAgregar').disabled=false; SAVING=false; return Swal.fire('Falta forma de pago','Eleg√≠ la forma de pago.','warning'); }
      await apiPost({ action:'venta_add', empleadoCodigo: emp.codigo, fdp, monto: unit, numItem: codigo, precioItem: unit, descripcion: descFinal, obs });
    }

    qs('#btnAgregar').disabled=false; SAVING=false; closeSaving();
    await cargarUltimas();

    // limpiar (y volver a pedir empleado si quer√©s: lo dejamos como estaba el s√°bado)
    qs('#inpCodigo').value=''; qs('#inpDesc').value=''; qs('#inpUnit').value='';
    qs('#inpRubro').value=''; qs('#fdp').value=''; qs('#obs').value='';
    if(SPLIT){ toggleTwo(); qs('#fdp1').value=''; qs('#fdp2').value=''; qs('#monto1').value=''; qs('#monto2').value=''; }

    Swal.fire({icon:'success', title:'Venta registrada', timer:1000, showConfirmButton:false});
    setTimeout(()=>showLogin(),650);
  }catch(e){
    qs('#btnAgregar').disabled=false; SAVING=false; closeSaving();
    Swal.fire('Error de red', e.message||'Fall√≥ la conexi√≥n', 'error');
  }
}

/* ====== Autorizados / Retiros & Cierre ====== */
function toggleAutorizados(){
  const emp=getEmp();
  qs('#panelRetiros').classList.toggle('hidden', !WITHDRAW_AUTH.includes((emp.codigo||'').toUpperCase()));
}
async function registrarMov(){
  const emp=getEmp(); if(!emp.codigo){ showLogin(); return; }
  const res=await apiPost({action:'mov_add', empleadoCodigo:emp.codigo, tipo:qs('#tipoMov').value, monto:Number(qs('#montoMov').value||0), descripcion:qs('#descMov').value.trim()});
  const p=qs('#msgMov'); if(res.ok){ p.textContent='Movimiento registrado'; qs('#montoMov').value=''; qs('#descMov').value=''; } else { p.textContent=res.error||'Error'; }
}
async function generarCierre(){
  const emp=getEmp(); if(!emp.codigo){ showLogin(); return; }
  if(!WITHDRAW_AUTH.includes(emp.codigo)){ Swal.fire('No autorizado','','warning'); return; }
  const d=qs('#cierreDate').value||new Date().toISOString().slice(0,10);
  Swal.fire({title:'Generando PDF‚Ä¶',allowOutsideClick:false,didOpen:()=>Swal.showLoading()});
  try{
    const r=await apiGet({action:'cierre_pdf', code:emp.codigo, date:d});
    Swal.close();
    if(r.ok&&r.data&&r.data.url){ window.open(r.data.url,'_blank'); Swal.fire('Cierre generado', r.data.name||'Listo para imprimir','success'); }
    else{ Swal.fire('Error', (r&&r.error)||'No se pudo generar el PDF','error'); }
  }catch(e){ Swal.close(); Swal.fire('Error de red', e.message||'Fall√≥ la conexi√≥n','error'); }
}

/* ====== Login ====== */
async function doLogin(){
  const code=(qs('#empCode').value||'').trim().toUpperCase();
  if(!code) return;
  const r=await apiGet({action:'login', code});
  const m=qs('#loginMsg');
  if(r.ok){ setEmp(r.data); m.textContent=''; hideLogin(); qs('#inpCodigo').focus(); }
  else { m.textContent=r.error||'C√≥digo inv√°lido'; }
}

/* ====== INIT ====== */
function init(){
  const d=new Date();
  qs('#hoy').textContent=d.toLocaleDateString('es-AR',{weekday:'short',day:'2-digit',month:'2-digit',year:'numeric'});
  qs('#fechaHoy').textContent=d.toLocaleDateString('es-AR');

  // Eventos
  qs('#inpCodigo').addEventListener('keydown', lookupDesdeCodigo);
  qs('#inpDesc').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); qs('#inpUnit').focus(); }});
  qs('#inpUnit').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); guardarVenta(); }});
  document.addEventListener('keydown', e=>{ if(e.key==='F9'){ e.preventDefault(); guardarVenta(); } if(e.key==='Enter' && e.target!==qs('#inpUnit')) e.preventDefault(); });

  qs('#btn2Medios').onclick = toggleTwo;
  qs('#monto1').addEventListener('input', recomputeMonto2);
  qs('#inpUnit').addEventListener('input', recomputeMonto2);

  qs('#btnAgregar').onclick = guardarVenta;
  qs('#btnMov').onclick = registrarMov;
  qs('#btnCierre').onclick = generarCierre;

  qs('#btnLogin').onclick=doLogin;
  qs('#empCode').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doLogin(); }});
  qs('#btnCambiar').onclick=showLogin;

  const emp=getEmp();
  if(!emp.codigo){ showLogin(); } else { qs('#empName').textContent=emp.nombre; toggleAutorizados(); }

  cargarUltimas();
}
init();
</script>
</body>
</html>
