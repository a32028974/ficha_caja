<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Emitir Comprobante â€¢ Ã“ptica Cristal</title>
<link rel="icon" href="logo.png"/>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  :root{--bg:#f7f7f8;--fg:#111;--muted:#666;--line:#e5e7eb;--btn:#1f2937;--btnH:#374151;}
  body{font-family:Arial, sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:18px}
  h1{margin:0 0 12px;font-size:1.2rem}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:14px}
  label{display:block;font-weight:600;margin-top:10px}
  input,select,button,textarea{width:100%;padding:10px;margin-top:6px;box-sizing:border-box;font-size:16px}
  textarea{min-height:64px;resize:vertical}
  button{background:var(--btn);color:#fff;border:0;border-radius:8px;cursor:pointer}
  button:hover{background:var(--btnH)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .muted{color:var(--muted);font-size:.9rem}
  #msg{position:sticky;top:0;background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:10px}
  .hidden{display:none}
</style>
</head>
<body>

<div id="msg">Listo</div>
<h1>Emitir Comprobante</h1>

<div class="card">
  <div class="row">
    <div>
      <label for="vend">CÃ³digo empleado</label>
      <input id="vend" placeholder="PonÃ© tu inicial" autocomplete="off"/>
      <div class="muted">Enter para validar y pasar al cÃ³digo.</div>
    </div>
    <div>
      <label for="codigo">CÃ³digo</label>
      <input id="codigo" placeholder="EscaneÃ¡ o escribÃ­" autocomplete="off"/>
    </div>
  </div>

  <label for="descripcion">DescripciÃ³n</label>
  <textarea id="descripcion" placeholder="DescripciÃ³n"></textarea>

  <div class="row">
    <div>
      <label for="precio">Precio total</label>
      <input id="precio" type="number" step="0.01" inputmode="decimal" value="0"/>
    </div>
    <div>
      <label for="obs">Observaciones (opcional)</label>
      <input id="obs" placeholder="Observacionesâ€¦"/>
    </div>
  </div>

  <hr/>

  <div>
    <label>Forma de pago</label>
    <div class="row">
      <select id="fdp">
        <option value="">â€” Elegir â€”</option>
        <option>EFECTIVO</option>
        <option>TARJETA DE DÃ‰BITO</option>
        <option>TARJETA DE CRÃ‰DITO</option>
        <option>TRANSFERENCIA</option>
        <option>PAY WAY</option>
      </select>
      <input id="monto" type="number" step="0.01" inputmode="decimal" placeholder="Monto"/>
    </div>

    <div style="margin-top:8px">
      <button id="btn-2medios" type="button">Usar 2 medios de pago</button>
    </div>

    <div id="split" class="hidden">
      <div class="row" style="margin-top:8px">
        <select id="fdp1">
          <option value="">â€” Medio 1 â€”</option>
          <option>EFECTIVO</option>
          <option>TARJETA DE DÃ‰BITO</option>
          <option>TARJETA DE CRÃ‰DITO</option>
          <option>TRANSFERENCIA</option>
          <option>PAY WAY</option>
        </select>
        <input id="monto1" type="number" step="0.01" inputmode="decimal" placeholder="Monto 1"/>
      </div>
      <div class="row" style="margin-top:8px">
        <select id="fdp2">
          <option value="">â€” Medio 2 â€”</option>
          <option>EFECTIVO</option>
          <option>TARJETA DE DÃ‰BITO</option>
          <option>TARJETA DE CRÃ‰DITO</option>
          <option>TRANSFERENCIA</option>
          <option>PAY WAY</option>
        </select>
        <input id="monto2" type="number" step="0.01" inputmode="decimal" placeholder="Monto 2"/>
      </div>
      <div class="muted">Los dos montos deben sumar el <b>Precio total</b>.</div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <button id="btn-registrar">Registrar venta</button>
    <button id="btn-cierre" type="button">Cierre de lote (hoy)</button>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const API = 'https://script.google.com/macros/s/AKfycbyF_tl-DwBa2i-2B7Uh-9naoqHBBbtXc9Xb2ae81ldu3MdAJcpxHHgXRNHG4MlmAffmhA/exec'; // TU /exec

/* ====== HELPERS ====== */
const $ = s => document.querySelector(s);
function msg(t, ok=true){ const m=$('#msg'); m.textContent=t; m.style.color=ok?'#111':'#b00020'; }
function qs(obj){ return Object.entries(obj).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v??'')}`).join('&'); }
function jsonp(url){
  return new Promise((resolve,reject)=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    window[cb]=(data)=>{ resolve(data); delete window[cb]; s.remove(); };
    const s=document.createElement('script');
    s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
    s.onerror=()=>{ delete window[cb]; s.remove(); reject(new Error('JSONP error')); };
    document.head.appendChild(s);
  });
}

/* ====== UI FLOW ====== */
// 1) Foco inicial en empleado
document.addEventListener('DOMContentLoaded', ()=>{
  $('#vend').focus();
});

// Enter en empleado â‡’ validar y pasar a cÃ³digo
$('#vend').addEventListener('keyup', async (e)=>{
  if(e.key!=='Enter') return;
  const code = ($('#vend').value||'').trim().toUpperCase();
  if(!code){ msg('IngresÃ¡ tu cÃ³digo', false); return; }
  const r = await jsonp(`${API}?action=validarVendedor&code=${encodeURIComponent(code)}`);
  if(r.ok){
    msg(`Hola ${r.nombre||r.codigo} ðŸ‘‹`);
    $('#codigo').focus();
  }else{
    msg(r.error||'CÃ³digo invÃ¡lido', false);
  }
});

// 2) Buscar cÃ³digo de artÃ­culo con SweetAlert
$('#codigo').addEventListener('change', async ()=>{
  const cod = ($('#codigo').value||'').trim();
  if(!cod) return;
  Swal.fire({title:'Buscando cÃ³digoâ€¦', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});
  try{
    const r = await jsonp(`${API}?action=getArticulo&codigo=${encodeURIComponent(cod)}`);
    if(r.ok){
      $('#descripcion').value = r.descripcion || '';
      $('#precio').value = r.precio || 0;
      // por comodidad, si vas a 1 medio, proponemos el total en "monto"
      $('#monto').value = r.precio || 0;
      Swal.fire({icon:'success', title:'ArtÃ­culo encontrado', timer:1200, showConfirmButton:false});
    }else{
      Swal.fire({icon:'warning', title:r.error||'No encontrado', timer:1500, showConfirmButton:false});
    }
  }catch(err){
    Swal.fire({icon:'error', title:'Error buscando cÃ³digo', text:String(err)});
  }
});

// 3) BotÃ³n 2 medios
$('#btn-2medios').addEventListener('click', ()=>{
  $('#split').classList.toggle('hidden');
});

/* ====== REGISTRAR VENTA ====== */
$('#btn-registrar').addEventListener('click', async ()=>{
  const vend = ($('#vend').value||'').trim().toUpperCase();
  if(!vend){ msg('IngresÃ¡ tu cÃ³digo', false); $('#vend').focus(); return; }

  const codigo = ($('#codigo').value||'').trim();
  const descripcion = ($('#descripcion').value||'').trim();
  const precio = Number($('#precio').value||0)||0;
  const obs = ($('#obs').value||'').trim();

  const splitVisible = !$('#split').classList.contains('hidden');

  let url;
  if (splitVisible){
    const fdp1 = $('#fdp1').value.trim();
    const fdp2 = $('#fdp2').value.trim();
    const m1 = Number($('#monto1').value||0)||0;
    const m2 = Number($('#monto2').value||0)||0;
    if(!fdp1 || !fdp2 || !m1 || !m2){ msg('CompletÃ¡ los dos medios y montos', false); return; }
    if(precio && m1+m2 !== precio){ msg('Los montos no suman el total', false); return; }

    url = `${API}?action=registrarVenta&` + qs({
      vendedor: vend, codigo, descripcion, precio,
      fdp1, monto1:m1, fdp2, monto2:m2, observaciones: obs
    });
  } else {
    const fdp = $('#fdp').value.trim();
    const monto = Number($('#monto').value||0)||0;
    if(!fdp || !monto){ msg('CompletÃ¡ forma de pago y monto', false); return; }

    url = `${API}?action=registrarVenta&` + qs({
      vendedor: vend, codigo, descripcion, precio,
      fdp, monto, observaciones: obs
    });
  }

  Swal.fire({title:'Guardandoâ€¦', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});
  try{
    const r = await jsonp(url);
    if(r.ok){
      Swal.fire({icon:'success', title:'Venta registrada', timer:1200, showConfirmButton:false});
      msg('Venta registrada âœ”');
      // limpiar para la prÃ³xima
      $('#codigo').value=''; $('#descripcion').value=''; $('#monto').value=''; $('#fdp').value='';
      $('#fdp1').value=''; $('#fdp2').value=''; $('#monto1').value=''; $('#monto2').value='';
      $('#obs').value=''; $('#split').classList.add('hidden');
      $('#precio').value=0;
      $('#codigo').focus();
    }else{
      Swal.fire({icon:'error', title:'No se pudo registrar', text:r.error||'Error'});
      msg(r.error||'No se pudo registrar', false);
    }
  }catch(err){
    Swal.fire({icon:'error', title:'Error de red', text:String(err)});
  }
});

/* ====== CIERRE DE LOTE ====== */
$('#btn-cierre').addEventListener('click', async ()=>{
  const r = await jsonp(`${API}?action=cierreLote`);
  if(!r.ok){ Swal.fire({icon:'error', title:'Error', text:r.error||'No se pudo calcular'}); return; }
  const tot = r.totales||{};
  const html = Object.keys(tot).map(k=>`<div><b>${k}</b>: $${tot[k]}</div>`).join('');
  Swal.fire({title:`Cierre ${r.dia}`, html: html+`<hr/><b>Total:</b> $${r.total_general}`});
});
</script>
</body>
</html>
