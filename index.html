<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emitir Comprobante v8 â€¢ Ã“ptica Cristal</title>
<link rel="icon" href="logo.png" />
<style>
  :root{
    --bg:#f5f6f8; --panel:#fff; --line:#e5e7eb; --muted:#6b7280;
    --blue:#2563eb; --green:#16a34a; --pill:#f9fafb;
  }
  *{ box-sizing:border-box; font-family:system-ui,Segoe UI,Arial,sans-serif; }
  body{ margin:0; background:var(--bg); color:#111; }
  header{ display:flex; align-items:center; gap:14px; padding:10px 14px; background:#fff; border-bottom:1px solid var(--line); position:sticky; top:0; z-index:5;}
  header img{ height:42px; }
  .title{ font-weight:700; font-size:20px; margin-right:auto; }
  .badge{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:999px; font-size:13px; }
  .wrap{ max-width:1100px; margin:18px auto; padding:0 14px 80px; }
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; margin:12px 0; }
  h3{ margin:6px 0 10px; font-size:16px; }
  label{ display:block; font-size:12px; color:var(--muted); margin:6px 0 4px; }
  input, select{ width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-size:15px; }
  .rowTop{ display:grid; grid-template-columns:140px 1fr; gap:10px; align-items:end; }
  .rowBottom{ display:grid; grid-template-columns:170px 150px 220px 140px 140px; gap:10px; align-items:end; }
  .btn{ padding:10px 14px; border:1px solid #d1d5db; border-radius:10px; background:#fff; cursor:pointer; }
  .btn.blue{ background:var(--blue); color:#fff; border-color:var(--blue); }
  .pill{ background:var(--pill); border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:13px; }
  .muted{ color:var(--muted); }
  .hidden{ display:none!important; }
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:100; }
  .modal .inner{ background:#fff; padding:22px; border-radius:12px; width:100%; max-width:380px; border:1px solid var(--line); text-align:center; }
</style>
</head>
<body>

<header>
  <img src="logo.png">
  <div class="title">Emitir Comprobante v8</div>
  <div class="badge">ðŸ“… <span id="hoy"></span></div>
  <div class="badge">ðŸ‘¤ <b id="empName">â€”</b></div>
  <button class="btn" id="btnCambiar">Cambiar empleado</button>
</header>

<div class="wrap">

<section class="card">
  <h3>Conceptos a facturar</h3>
  <div class="rowTop">
    <div>
      <label>CÃ³digo</label>
      <input id="inpCodigo" placeholder="EscaneÃ¡ o escribÃ­ y Enter">
    </div>
    <div>
      <label>DescripciÃ³n</label>
      <input id="inpDesc" placeholder="Se completa desde Stock (editable)">
    </div>
  </div>

  <div class="rowBottom" style="margin-top:10px">
    <div>
      <label>Rubro</label>
      <select id="inpRubro">
        <option value="">â€” Elegir rubro â€”</option>
        <option>Receta</option>
        <option>Lentes de contacto</option>
        <option>LÃ­quidos LC</option>
        <option>Reparaciones y varios</option>
        <option>Sol</option>
        <option>Fotos y pilas</option>
      </select>
    </div>

    <div>
      <label>Precio Unit.</label>
      <input type="number" id="inpUnit" inputmode="decimal" placeholder="0">
    </div>

    <div>
      <label>Forma de pago (1 medio)</label>
      <select id="fdp1">
        <option value="">â€” Elegir â€”</option>
        <option>EFECTIVO</option>
        <option>MERCADOPAGO</option>
        <option>TRANSFERENCIA</option>
        <option>TARJETA DE CRÃ‰DITO</option>
        <option>TARJETA DE DEBITO</option>
      </select>
    </div>

    <div>
      <label>Monto 1</label>
      <input type="number" id="monto1" inputmode="decimal" value="0">
    </div>

    <div>
      <label style="visibility:hidden">-</label>
      <button class="btn" id="btnToggle2">1 medio</button>
    </div>
  </div>

  <div id="medios2" class="hidden" style="display:grid; grid-template-columns:1fr 150px 1fr 150px; gap:10px; margin-top:12px;">
    <div>
      <label>Forma de pago 2</label>
      <select id="fdp2">
        <option>EFECTIVO</option>
        <option>MERCADOPAGO</option>
        <option>TRANSFERENCIA</option>
        <option>TARJETA DE CRÃ‰DITO</option>
        <option>TARJETA DE DEBITO</option>
      </select>
    </div>
    <div>
      <label>Monto 2 (auto)</label>
      <input type="number" id="monto2" inputmode="decimal" value="0">
    </div>
  </div>

  <div style="margin-top:10px">
    <label>Observaciones</label>
    <input id="obs">
  </div>

  <div style="margin-top:12px;">
    <button class="btn blue" id="btnRegistrar">Registrar venta (F9)</button>
  </div>
</section>

<section class="card">
  <h3>Ãšltimas ventas (3)</h3>
  <div id="ultimas" class="muted">â€”</div>
</section>

</div>

<!-- LOGIN -->
<div class="modal" id="loginModal">
  <div class="inner">
    <h3>Ingresar empleado</h3>
    <p class="muted">Letra / CÃ³digo corto</p>
    <input id="empCode" style="text-align:center; font-size:20px;">
    <button class="btn blue" id="btnLogin" style="margin-top:12px;">Entrar</button>
  </div>
</div>

<!-- LOADING -->
<div class="modal hidden" id="loadingModal">
  <div class="inner">
    <h3 id="loadingMsg">Procesandoâ€¦</h3>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
const API = 'https://script.google.com/macros/s/AKfycbyF_tl-DwBa2i-2B7Uh-9naoqHBBbtXc9Xb2ae81ldu3MdAJcpxHHgXRNHG4MlmAffmhA/exec';

const qs=s=>document.querySelector(s);
function showLoading(m){ qs('#loadingMsg').textContent=m||'Procesandoâ€¦'; qs('#loadingModal').classList.remove('hidden'); }
function hideLoading(){ qs('#loadingModal').classList.add('hidden'); }

async function apiGet(p){ const r=await fetch(API+'?'+new URLSearchParams(p)); return r.json(); }
async function apiPost(o){ const r=await fetch(API,{method:'POST',body:JSON.stringify(o)}); return r.json(); }

function login(){
  const code=qs('#empCode').value.trim().toUpperCase();
  if(!code) return;
  showLoading("Verificando empleadoâ€¦");
  apiGet({action:'login',code}).then(r=>{
    hideLoading();
    if(!r.ok) return Swal.fire('CÃ³digo invÃ¡lido','','warning');
    localStorage.setItem('OC_EMP_CODE',r.data.codigo);
    localStorage.setItem('OC_EMP_NAME',r.data.nombre);
    qs('#empName').textContent=r.data.nombre;
    qs('#loginModal').classList.add('hidden');
    qs('#inpCodigo').focus();
  });
}

qs('#btnLogin').onclick=login;
qs('#empCode').onkeydown=e=>{ if(e.key==='Enter') login(); };
qs('#btnCambiar').onclick=()=>{ qs('#loginModal').classList.remove('hidden'); setTimeout(()=>qs('#empCode').focus(),50); };

let modo2=false;
qs('#btnToggle2').onclick=()=>{
  modo2=!modo2;
  qs('#medios2').classList.toggle('hidden',!modo2);
  qs('#btnToggle2').textContent = modo2 ? "2 medios" : "1 medio";
  recalcular();
};

function recalcular(){
  const total = Number(qs('#inpUnit').value||0);
  const m1 = Number(qs('#monto1').value||0);
  qs('#monto2').value = Math.max(total - m1,0);
}
qs('#monto1').oninput=recalcular;
qs('#inpUnit').oninput=recalcular;

qs('#inpCodigo').addEventListener('keydown', async e=>{
  if(e.key!=='Enter') return;
  const num=(qs('#inpCodigo').value||'').trim();
  if(!num) return;
  showLoading("Buscando productoâ€¦");
  const r=await apiGet({action:'stock_get',num});
  hideLoading();
  if(!r.ok) return Swal.fire('No encontrado','','warning');
  qs('#inpDesc').value=r.data.descripcion;
  qs('#inpUnit').value=r.data.precio;
  recalcular();
  qs('#inpDesc').focus();
});

qs('#btnRegistrar').onclick = registrarVenta;
document.addEventListener('keydown',e=>{ if(e.key==='F9'){ e.preventDefault(); registrarVenta(); }});

async function registrarVenta(){
  const emp = localStorage.getItem('OC_EMP_CODE');
  if(!emp) return;
  const desc=qs('#inpDesc').value.trim();
  const rub=qs('#inpRubro').value.trim();
  const total=Number(qs('#inpUnit').value||0);
  if(!desc||!rub||total<=0) return Swal.fire("Faltan datos","","warning");

  let pagos=[];
  if(!modo2){
    pagos=[{ fdp:qs('#fdp1').value, monto:total }];
  }else{
    pagos=[
      { fdp:qs('#fdp1').value, monto:Number(qs('#monto1').value||0) },
      { fdp:qs('#fdp2').value, monto:Number(qs('#monto2').value||0) }
    ];
  }

  showLoading("Guardando ventaâ€¦");
  const r=await apiPost({
    action:'venta_add',
    empleadoCodigo:emp,
    descripcion:`${rub}: ${desc}`,
    pagos,
    numItem:qs('#inpCodigo').value.trim(),
    precioItem:total,
    obs:qs('#obs').value.trim()
  });
  hideLoading();

  if(!r.ok) return Swal.fire("Error",r.error,"error");
  limpiar();
  cargarUltimas();
  qs('#loginModal').classList.remove('hidden');
  setTimeout(()=>qs('#empCode').focus(),50);
}

function limpiar(){
  qs('#inpCodigo').value='';
  qs('#inpDesc').value='';
  qs('#monto1').value='0';
  qs('#monto2').value='0';
  qs('#inpUnit').value='';
  qs('#obs').value='';
  qs('#inpCodigo').focus();
}

async function cargarUltimas(){
  const r=await apiGet({action:'ultimas',n:3});
  if(!r.ok||!r.data.length){ qs('#ultimas').textContent='â€”'; return; }
  qs('#ultimas').innerHTML = r.data.map(x=>`<div class="pill" style="margin:4px 0">${x.emp} â€¢ ${x.fdp} â€¢ ${x.desc} â€¢ $${x.total}</div>`).join('');
}

(function init(){
  qs('#loginModal').classList.remove('hidden');
  setTimeout(()=>qs('#empCode').focus(),80);
  cargarUltimas();
})();
</script>
</body>
</html>
